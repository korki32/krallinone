<!DOCTYPE html>
<html lang="hu">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Counter-Strike kv√≠z</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/tone@14.7.58/build/Tone.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --quiz-color: #2dd4bf; /* teal-400 */
        }
        body {
            font-family: 'Inter', sans-serif;
            background: #0f172a; /* H√°tteret s√∂t√©tebb√© tettem */
            background-image: linear-gradient(135deg, #0f172a 25%, #1f2937 50%, #0f2a71 75%);
            background-size: 400% 400%;
            animation: gradient-animation 20s ease infinite;
        }

        @keyframes gradient-animation {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        .btn-answer {
            transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
            border: 2px solid transparent;
        }
        .btn-answer:hover {
            transform: translateY(-5px) scale(1.02);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
            border-color: var(--quiz-color);
        }

        .correct-answer {
            animation: pulse-correct 1s forwards;
            background-color: #16a34a !important; /* z√∂ld */
        }
        @keyframes pulse-correct {
            0% { transform: scale(1); box-shadow: 0 0 0 rgba(22, 163, 74, 0.7); }
            50% { transform: scale(1.05); box-shadow: 0 0 20px rgba(22, 163, 74, 1); }
            100% { transform: scale(1); box-shadow: 0 0 0 rgba(22, 163, 74, 0); }
        }

        .incorrect-answer {
            animation: shake 0.5s cubic-bezier(.36,.07,.19,.97) both;
            background-color: #dc2626 !important; /* piros */
        }
        @keyframes shake {
            10%, 90% { transform: translate3d(-1px, 0, 0); }
            20%, 80% { transform: translate3d(2px, 0, 0); }
            30%, 50%, 70% { transform: translate3d(-4px, 0, 0); }
            40%, 60% { transform: translate3d(4px, 0, 0); }
        }

        .game-over-animation {
            animation: gameOver 2s ease-in-out forwards;
        }
        @keyframes gameOver {
            0% { transform: scale(1); opacity: 1; }
            50% { transform: scale(0.95) rotate(-5deg); opacity: 0.5; }
            100% { transform: scale(0.8) rotate(0); opacity: 0; }
        }

        /* √öj anim√°ci√≥ a pontsz√°m n√∂vel√©s√©hez */
        .score-pulse {
            animation: score-pulse 0.5s ease-in-out;
        }
        @keyframes score-pulse {
            0% { transform: scale(1); color: inherit; }
            50% { transform: scale(1.2); color: #2dd4bf; }
            100% { transform: scale(1); color: inherit; }
        }

        .loader {
            border-top-color: #3498db;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        #timer-bar {
            height: 8px;
            background-color: #16a34a; /* z√∂ld */
            transition: width 0.5s linear, background-color 0.5s ease-in-out;
            border-radius: 9999px;
        }

        .timer-warning {
            background-color: #dc2626 !important; /* piros */
            animation: pulse-timer 1s infinite;
        }

        @keyframes pulse-timer {
            0%, 100% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.02); opacity: 0.7; }
        }
        
        .joker-button {
            position: relative;
            transition: transform 0.2s ease-in-out;
        }

        .joker-button:disabled {
            filter: grayscale(100%);
            opacity: 0.6;
            transform: scale(0.9);
            cursor: not-allowed;
        }

        .joker-tooltip {
            visibility: hidden;
            background-color: #1f2937;
            color: #fff;
            text-align: center;
            border-radius: 6px;
            padding: 5px 10px;
            position: absolute;
            z-index: 1;
            bottom: 125%;
            left: 50%;
            transform: translateX(-50%);
            white-space: nowrap;
            opacity: 0;
            transition: opacity 0.3s;
        }
        .joker-button:hover .joker-tooltip {
            visibility: visible;
            opacity: 1;
        }
        .joker-icon {
            font-size: 1rem;
            margin-left: 0.5rem;
            color: #6ee7b7;
        }

        .confetti-piece {
            position: absolute;
            width: 10px;
            height: 10px;
            background-color: var(--color);
            border-radius: 50%;
            animation: confetti-fall 2s linear forwards;
            opacity: 0;
            transform: translateY(-100vh);
        }

        @keyframes confetti-fall {
            0% { transform: translateY(-100vh) rotate(0deg); opacity: 0; }
            1% { opacity: 1; }
            100% { transform: translateY(100vh) rotate(720deg); opacity: 1; }
        }

    </style>
</head>
<body class="text-gray-200 flex items-center justify-center min-h-screen p-4">

    <div id="quiz-container" class="bg-gray-800 bg-opacity-80 backdrop-blur-md p-8 rounded-3xl shadow-2xl w-full max-w-lg border border-gray-700">
        <!-- Timer and Joker buttons -->
        <div class="flex flex-col sm:flex-row items-center justify-between mb-4">
            <div id="timer-display" class="w-full h-2 bg-gray-600 rounded-full overflow-hidden mb-4 sm:mb-0 sm:mr-4">
                <div id="timer-bar" class="w-full"></div>
            </div>
            <div class="flex space-x-2">
                <button id="joker-50-btn" class="joker-button py-2 px-4 bg-gray-700 text-sm font-bold text-white rounded-lg shadow-md transition-all duration-300 hover:bg-teal-500">
                    <i class="fa-solid fa-divide"></i>
                    <span class="joker-tooltip">50:50 - K√©t rossz v√°laszt elt√°vol√≠t</span>
                </button>
                <button id="joker-time-btn" class="joker-button py-2 px-4 bg-gray-700 text-sm font-bold text-white rounded-lg shadow-md transition-all duration-300 hover:bg-teal-500">
                    <i class="fa-solid fa-clock"></i>
                    <span class="joker-tooltip">+10 m√°sodpercet ad az id≈ëh√∂z</span>
                </button>
                <button id="joker-skip-btn" class="joker-button py-2 px-4 bg-gray-700 text-sm font-bold text-white rounded-lg shadow-md transition-all duration-300 hover:bg-teal-500">
                    <i class="fa-solid fa-forward"></i>
                    <span class="joker-tooltip">√Åtl√©pi a jelenlegi k√©rd√©st</span>
                </button>
            </div>
        </div>
        <div class="flex items-center justify-between mb-6 text-sm text-gray-400">
            <span id="score-display" class="font-medium">Pontsz√°m: 0 üéØ</span>
            <span id="question-counter" class="font-medium">K√©rd√©s: 1/0 üìù</span>
        </div>
        
        <div id="loading-screen" class="text-center p-8 hidden">
            <div class="inline-block h-12 w-12 animate-spin rounded-full border-4 border-solid border-current border-r-transparent text-teal-500" role="status">
                <span class="!absolute !-m-px !h-px !-w-px !-overflow-hidden !whitespace-nowrap !border-0 !p-0 ![clip:rect(0,0,0,0)]">Loading...</span>
            </div>
            <p class="mt-4 text-gray-400 text-lg font-semibold">K√©rd√©sek bet√∂lt√©se...</p>
        </div>

        <div id="quiz-content" class="animate-fade-in hidden">
            <h2 id="question-text" class="text-2xl font-extrabold mb-8 text-center text-teal-400 leading-snug"></h2>
            <div id="answer-buttons" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <!-- Answer buttons will be generated here -->
            </div>
        </div>

        <div id="end-screen" class="text-center hidden animate-fade-in">
            <h2 class="text-3xl font-extrabold text-teal-400 mb-4">Kv√≠z v√©ge!</h2>
            <p id="final-score" class="text-xl mb-6 font-medium"></p>
            
            <div id="name-input-section" class="mb-6">
                <p class="mb-2">Add meg a neved a ranglist√°hoz:</p>
                <input type="text" id="player-name" class="w-full p-3 rounded-lg bg-gray-700 border border-gray-600 text-white placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-teal-500 focus:border-transparent" placeholder="Pl.: ProGamer3000">
                <button id="save-score-btn" class="w-full bg-teal-600 hover:bg-teal-700 text-white font-bold py-3 px-6 rounded-lg shadow-md transition-all duration-300 mt-4">Pontsz√°m ment√©se</button>
            </div>
            
            <button id="restart-btn" class="w-full bg-gray-600 hover:bg-gray-500 text-white font-bold py-3 px-6 rounded-lg shadow-md transition-all duration-300">√öjra j√°tszom</button>
        </div>

        <div id="leaderboard-screen" class="hidden animate-fade-in mt-6">
            <h3 class="text-2xl font-extrabold text-teal-400 mb-4 text-center">Ranglista üèÜ</h3>
            <ul id="leaderboard-list" class="space-y-2">
                <!-- Leaderboard items will be generated here -->
                <div id="loader" class="text-center hidden">
                    <div class="inline-block h-8 w-8 animate-spin rounded-full border-4 border-solid border-current border-r-transparent text-teal-500" role="status">
                        <span class="!absolute !-m-px !h-px !-w-px !-overflow-hidden !whitespace-nowrap !border-0 !p-0 ![clip:rect(0,0,0,0)]">Loading...</span>
                    </div>
                    <p class="mt-2 text-gray-400">Ranglista bet√∂lt√©se...</p>
                </div>
            </ul>
            <button id="leaderboard-restart-btn" class="w-full bg-gray-600 hover:bg-gray-500 text-white font-bold py-3 px-6 rounded-lg shadow-md transition-all duration-300 mt-6">√öjra j√°tszom</button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, addDoc, setDoc, updateDoc, deleteDoc, onSnapshot, collection, query, where, getDocs, orderBy, limit } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // Firebase configuration and initialization
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        
        let userId = null;
        let authReady = false;

        let questions = [];
        let questionsLoaded = false;
        
        // Quiz state variables
        let currentQuestionIndex = 0;
        let score = 0;
        let selectedAnswer = null;
        let jokers = {
            '50': true,
            'time': true,
            'skip': true
        };
        let usedJokersThisGame = {
            '50': false,
            'time': false,
            'skip': false
        };
        let timer = null;
        const timeLimit = 15; // 15 seconds
        let timeRemaining = timeLimit;

        // UI elements
        const quizContainer = document.getElementById('quiz-container');
        const loadingScreen = document.getElementById('loading-screen');
        const quizContent = document.getElementById('quiz-content');
        const endScreen = document.getElementById('end-screen');
        const leaderboardScreen = document.getElementById('leaderboard-screen');
        const questionText = document.getElementById('question-text');
        const answerButtonsContainer = document.getElementById('answer-buttons');
        const scoreDisplay = document.getElementById('score-display');
        const questionCounter = document.getElementById('question-counter');
        const restartBtn = document.getElementById('restart-btn');
        const leaderboardRestartBtn = document.getElementById('leaderboard-restart-btn');
        const finalScore = document.getElementById('final-score');
        const saveScoreBtn = document.getElementById('save-score-btn');
        const playerNameInput = document.getElementById('player-name');
        const leaderboardList = document.getElementById('leaderboard-list');
        const loader = document.getElementById('loader');
        const joker50Btn = document.getElementById('joker-50-btn');
        const jokerTimeBtn = document.getElementById('joker-time-btn');
        const jokerSkipBtn = document.getElementById('joker-skip-btn');
        const timerBar = document.getElementById('timer-bar');

        // Initialize sound effects
        const synth = new Tone.PolySynth(Tone.Synth).toDestination();

        // Different sounds
        const correctSound = () => synth.triggerAttackRelease("C6", "8n");
        const incorrectSound = () => synth.triggerAttackRelease("F#2", "8n");
        const gameOverSound = () => synth.triggerAttackRelease(["C3", "G#2"], "1s");
        const tickSound = () => synth.triggerAttackRelease("C4", "16n");
        const confettiSound = () => synth.triggerAttackRelease(["C5", "E5", "G5"], "8n");

        // Function to fetch questions from external URL
        async function fetchQuestions() {
            loadingScreen.classList.remove('hidden');
            quizContent.classList.add('hidden');
            try {
                const response = await fetch('https://raw.githubusercontent.com/korki32/krallinone/main/kviz.json');
                if (!response.ok) {
                    throw new Error(`HTTP hiba! St√°tusz: ${response.status}`);
                }
                const rawQuestions = await response.json();

                // Convert the `correctAnswer` index to the actual answer string and rename `imageUrl`
                questions = rawQuestions.map(q => ({
                    question: q.question,
                    answers: q.answers,
                    correct: q.answers[q.correctAnswer],
                    image: q.imageUrl // Rename imageUrl to image for compatibility
                }));

                questionsLoaded = true;
                loadingScreen.classList.add('hidden');
                quizContent.classList.remove('hidden');
                startQuiz();
            } catch (error) {
                console.error("Hiba a k√©rd√©sek let√∂lt√©sekor: ", error);
                loadingScreen.innerHTML = `<p class="text-red-500 font-bold">Hiba t√∂rt√©nt a k√©rd√©sek bet√∂lt√©se k√∂zben. Pr√≥b√°lja meg k√©s≈ëbb!</p>`;
            }
        }

        // Function to start the quiz
        function startQuiz() {
            if (!questionsLoaded) {
                fetchQuestions();
                return;
            }
            
            currentQuestionIndex = 0;
            score = 0;
            selectedAnswer = null;
            jokers = { '50': true, 'time': true, 'skip': true };
            usedJokersThisGame = { '50': false, 'time': false, 'skip': false };
            updateJokerButtons();
            
            quizContainer.classList.remove('hidden');
            quizContent.classList.remove('hidden', 'game-over-animation');
            endScreen.classList.add('hidden');
            leaderboardScreen.classList.add('hidden');
            playerNameInput.value = '';
            scoreDisplay.textContent = `Pontsz√°m: ${score} üéØ`;
            showQuestion();
        }

        // Start the timer
        function startTimer() {
            timeRemaining = timeLimit;
            timerBar.style.width = '100%';
            timerBar.style.backgroundColor = '#16a34a';
            timerBar.classList.remove('timer-warning');

            // Clear previous timer if exists
            if (timer) clearInterval(timer);

            timer = setInterval(() => {
                timeRemaining--;
                const percentage = (timeRemaining / timeLimit) * 100;
                timerBar.style.width = `${percentage}%`;

                if (timeRemaining <= 5) {
                    timerBar.classList.add('timer-warning');
                    tickSound();
                }

                if (timeRemaining <= 0) {
                    clearInterval(timer);
                    selectedAnswer = "time_out";
                    handleAnswer(null, null); // Incorrect answer, time ran out
                }
            }, 1000);
        }

        // Update the state of joker buttons
        function updateJokerButtons() {
            joker50Btn.disabled = !jokers['50'];
            jokerTimeBtn.disabled = !jokers['time'];
            jokerSkipBtn.disabled = !jokers['skip'];
        }

        // Function to display the question
        function showQuestion() {
            if (currentQuestionIndex >= questions.length) {
                clearInterval(timer);
                showFinalScore(true);
                return;
            }
            
            startTimer();

            const currentQuestion = questions[currentQuestionIndex];
            questionText.textContent = currentQuestion.question;
            questionCounter.textContent = `K√©rd√©s: ${currentQuestionIndex + 1}/${questions.length} üìù`;

            const existingImage = document.getElementById('question-image');
            if (existingImage) {
                existingImage.remove();
            }

            if (currentQuestion.image) {
                const img = document.createElement('img');
                img.id = 'question-image';
                img.src = currentQuestion.image;
                img.alt = 'J√°t√©kos k√©pe';
                img.classList.add('w-full', 'h-auto', 'rounded-lg', 'mb-6');
                questionText.insertAdjacentElement('beforebegin', img);
            }

            // Clear previous buttons
            while (answerButtonsContainer.firstChild) {
                answerButtonsContainer.removeChild(answerButtonsContainer.firstChild);
            }

            // Create buttons for answers
            currentQuestion.answers.forEach(answer => {
                const button = document.createElement('button');
                button.textContent = answer;
                button.classList.add(
                    'btn-answer',
                    'bg-gray-700',
                    'hover:bg-gray-600',
                    'text-left',
                    'text-white',
                    'py-3',
                    'px-4',
                    'rounded-lg',
                    'font-medium',
                    'transition-all',
                    'duration-300',
                    'flex',
                    'items-center',
                    'w-full',
                    'transform'
                );
                button.addEventListener('click', () => handleAnswer(button, answer));
                answerButtonsContainer.appendChild(button);
            });
        }

        // Joker functions
        joker50Btn.addEventListener('click', () => {
            if (!jokers['50']) return;
            jokers['50'] = false;
            usedJokersThisGame['50'] = true;
            updateJokerButtons();

            const currentQuestion = questions[currentQuestionIndex];
            const correctText = currentQuestion.correct;
            const answerButtons = Array.from(answerButtonsContainer.children);
            
            const incorrectAnswers = answerButtons.filter(btn => btn.textContent !== correctText);

            for (let i = 0; i < 2; i++) {
                if (incorrectAnswers.length > 0) {
                    const randomIndex = Math.floor(Math.random() * incorrectAnswers.length);
                    incorrectAnswers[randomIndex].style.display = 'none';
                    incorrectAnswers.splice(randomIndex, 1);
                }
            }
        });
        
        jokerTimeBtn.addEventListener('click', () => {
            if (!jokers['time']) return;
            jokers['time'] = false;
            usedJokersThisGame['time'] = true;
            updateJokerButtons();
            
            timeRemaining += 10;
        });

        jokerSkipBtn.addEventListener('click', () => {
            if (!jokers['skip']) return;
            jokers['skip'] = false;
            usedJokersThisGame['skip'] = true;
            updateJokerButtons();

            clearInterval(timer);
            selectedAnswer = null;
            currentQuestionIndex++;
            showQuestion();
        });


        // Handle selected answer with animations
        function handleAnswer(button, answer) {
            clearInterval(timer);
            
            // Allow only one answer
            if (selectedAnswer !== null) return;
            selectedAnswer = answer;
            
            const isTimeout = selectedAnswer === "time_out";
            const currentQuestion = questions[currentQuestionIndex];
            const isCorrect = answer === currentQuestion.correct;

            // Disable all buttons
            document.querySelectorAll('.btn-answer').forEach(btn => {
                btn.disabled = true;
                btn.classList.remove('hover:bg-gray-600', 'hover:text-white');
            });
            
            // Add animation and color for correct/incorrect answer
            if (isCorrect) {
                correctSound();
                button.classList.add('correct-answer');
                score++;
                scoreDisplay.textContent = `Pontsz√°m: ${score} üéØ`;
                // Trigger score pulse animation
                scoreDisplay.classList.add('score-pulse');
                setTimeout(() => {
                    scoreDisplay.classList.remove('score-pulse');
                }, 500); // Remove class after 0.5 seconds
                
                // Wait for the animation to finish, then proceed
                setTimeout(() => {
                    selectedAnswer = null;
                    currentQuestionIndex++;
                    showQuestion();
                }, 1500); // Proceed to the next question after 1.5 seconds
            } else {
                incorrectSound();
                // If it's a timeout, find a random incorrect button to highlight
                if (isTimeout) {
                    const allButtons = Array.from(answerButtonsContainer.children);
                    const incorrectButtons = allButtons.filter(btn => btn.textContent !== currentQuestion.correct);
                    if (incorrectButtons.length > 0) {
                        const randomIncorrectButton = incorrectButtons[Math.floor(Math.random() * incorrectButtons.length)];
                        randomIncorrectButton.classList.add('incorrect-answer');
                    }
                } else {
                     // If it's a regular incorrect click, highlight the clicked button
                    button.classList.add('incorrect-answer');
                }

                // Always highlight the correct answer on an incorrect attempt or timeout
                const correctButton = Array.from(answerButtonsContainer.children).find(btn => btn.textContent === currentQuestion.correct);
                if (correctButton) {
                    correctButton.classList.add('correct-answer');
                }
                
                // Game over on incorrect answer or timeout
                setTimeout(() => {
                    gameOverSound();
                    quizContent.classList.add('game-over-animation');
                    setTimeout(() => {
                        showFinalScore(false); // Game over due to wrong answer or timeout
                    }, 1000); // Wait for animation
                }, 500); // Wait for button animation
            }
        }

        // Display final score
        function showFinalScore(isGameComplete) {
            quizContent.classList.add('hidden');
            quizContent.classList.remove('game-over-animation'); // Clear animation for next game
            endScreen.classList.remove('hidden');
            
            if (isGameComplete) {
                finalScore.textContent = `Gratul√°lunk, v√©gigj√°tszottad a kv√≠zt! A v√©gs≈ë pontsz√°mod: ${score} a ${questions.length}-b√≥l! üéâ`;
                if (score === questions.length) {
                    createConfetti();
                    confettiSound();
                }
            } else {
                finalScore.textContent = `Game Over! A v√©gs≈ë pontsz√°mod: ${score}. üò≠`;
            }
        }
        
        // Function to create confetti effect
        function createConfetti() {
            const colors = ['#f44336', '#e91e63', '#9c27b0', '#673ab7', '#3f51b5', '#2196f3', '#03a9f4', '#00bcd4', '#009688', '#4caf50', '#8bc34a', '#cddc39', '#ffeb3b', '#ffc107', '#ff9800', '#ff5722', '#795548', '#9e9e9e', '#607d8b'];
            for (let i = 0; i < 100; i++) {
                const confetti = document.createElement('div');
                confetti.classList.add('confetti-piece');
                confetti.style.left = `${Math.random() * 100}vw`;
                confetti.style.animationDelay = `${Math.random() * 2}s`;
                confetti.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
                confetti.style.transform = `translateY(-100vh) rotate(${Math.random() * 720}deg)`;
                document.body.appendChild(confetti);
            }
            setTimeout(() => {
                document.querySelectorAll('.confetti-piece').forEach(c => c.remove());
            }, 3000);
        }

        // Save score to Firestore
        saveScoreBtn.addEventListener('click', async () => {
            // Prevent multiple saves
            saveScoreBtn.disabled = true;
            saveScoreBtn.textContent = 'Ment√©s...';
            saveScoreBtn.classList.add('opacity-50', 'cursor-not-allowed');

            const playerName = playerNameInput.value.trim() || 'N√©vtelen j√°t√©kos';
            const newScore = {
                name: playerName,
                score: score,
                userId: userId,
                jokersUsed: usedJokersThisGame,
                timestamp: new Date().toISOString()
            };
            
            try {
                const scoresCollection = collection(db, `artifacts/${appId}/public/data/high_scores`);
                await addDoc(scoresCollection, newScore);
                console.log("Score successfully saved.");
                showLeaderboard();
            } catch (e) {
                console.error("Error saving score: ", e);
                let highScores = JSON.parse(localStorage.getItem('cs_high_scores') || '[]');
                const localScore = {
                    name: playerName,
                    score: score,
                    jokersUsed: usedJokersThisGame,
                    date: new Date().toISOString()
                };
                highScores.push(localScore);
                highScores.sort((a, b) => b.score - a.score);
                highScores = highScores.slice(0, 10);
                localStorage.setItem('cs_high_scores', JSON.stringify(highScores));
                showLeaderboard(true);
            } finally {
                // Always reset button regardless of the outcome
                saveScoreBtn.disabled = false;
                saveScoreBtn.textContent = 'Pontsz√°m ment√©se';
                saveScoreBtn.classList.remove('opacity-50', 'cursor-not-allowed');
            }
        });

        // Display leaderboard
        function showLeaderboard(useLocalStorage = false) {
            endScreen.classList.add('hidden');
            leaderboardScreen.classList.remove('hidden');
            loader.classList.remove('hidden');
            leaderboardList.innerHTML = '';
            
            if (useLocalStorage) {
                 const highScores = JSON.parse(localStorage.getItem('cs_high_scores') || '[]');
                 renderLeaderboard(highScores, true);
                 return;
            }

            // Load leaderboard in real-time from Firestore
            const scoresCollection = collection(db, `artifacts/${appId}/public/data/high_scores`);
            const q = query(scoresCollection, orderBy('score', 'desc'), limit(10));
            
            onSnapshot(q, (snapshot) => {
                loader.classList.add('hidden');
                const highScores = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderLeaderboard(highScores);
            }, (error) => {
                console.error("Error fetching leaderboard: ", error);
                loader.classList.add('hidden');
                // Fallback to local storage on error
                showLeaderboard(true);
            });
        }
        
        function renderLeaderboard(highScores, isLocal = false) {
            leaderboardList.innerHTML = '';
            if (highScores.length === 0) {
                const li = document.createElement('li');
                li.textContent = 'M√©g nincsenek pontsz√°mok. L√©gy te az els≈ë!';
                li.classList.add('text-center', 'text-gray-500');
                leaderboardList.appendChild(li);
                return;
            }
            
            highScores.forEach((entry, index) => {
                const li = document.createElement('li');
                li.classList.add('flex', 'justify-between', 'bg-gray-700', 'p-3', 'rounded-lg', 'shadow-sm', 'border-l-4', 'border-teal-500');
                const rank = index + 1;
                let emoji = '';
                if (rank === 1) emoji = 'ü•á';
                else if (rank === 2) emoji = 'ü•à';
                else if (rank === 3) emoji = 'ü•â';
                
                let nameToDisplay = entry.name;
                
                let jokerIcons = '';
                if (entry.jokersUsed) {
                    if (entry.jokersUsed['50']) {
                        jokerIcons += '<i class="fa-solid fa-divide joker-icon" title="50:50"></i>';
                    }
                    if (entry.jokersUsed['time']) {
                        jokerIcons += '<i class="fa-solid fa-clock joker-icon" title="Id≈ëp√≥tl√≥"></i>';
                    }
                    if (entry.jokersUsed['skip']) {
                        jokerIcons += '<i class="fa-solid fa-forward joker-icon" title="Kihagy√°s"></i>';
                    }
                }

                li.innerHTML = `
                    <div class="flex items-center">
                        <span class="font-bold text-teal-300 w-6">#${rank}. ${emoji}</span>
                        <span class="font-medium">${nameToDisplay}</span>
                        ${jokerIcons}
                    </div>
                    <span class="text-right text-gray-400 font-bold">${entry.score} pont</span>
                `;
                leaderboardList.appendChild(li);
            });
        }

        // Restart buttons
        restartBtn.addEventListener('click', startQuiz);
        leaderboardRestartBtn.addEventListener('click', startQuiz);

        // Firebase authentication
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                userId = user.uid;
                authReady = true;
            } else {
                try {
                    if (initialAuthToken) {
                        const userCredential = await signInWithCustomToken(auth, initialAuthToken);
                        userId = userCredential.user.uid;
                    } else {
                        const userCredential = await signInAnonymously(auth);
                        userId = userCredential.user.uid;
                    }
                    authReady = true;
                } catch (error) {
                    console.error("Authentication error: ", error);
                    authReady = true;
                }
            }
            
            if (authReady) {
                 startQuiz();
            }
        });
    </script>
</body>
</html>
