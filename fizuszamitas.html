<!DOCTYPE html>
<html lang="hu">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Műszak és Fizetés Kalkulátor V6.4 - Bejárási Támogatás</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            background: #0d1117;
        }

        .glass-panel {
            background-color: rgba(24, 30, 41, 0.85);
            backdrop-filter: blur(12px);
            position: relative;
            z-index: 10;
            border: 1px solid #374151;
        }

        #futuristic-canvas {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -2;
        }

        /* Custom styles to override Tailwind for the new theme */
        .container {
            width: 100%;
            max-width: 60rem;
            padding: 2rem;
            display: grid;
            gap: 2rem;
            grid-template-areas: "header" "main" "results";
        }

        @media (min-width: 1024px) {
            .container {
                grid-template-areas: "header header" "main main" "results results";
            }
        }

        .header {
            grid-area: header;
        }

        .main-content {
            grid-area: main;
        }

        .results-container {
            grid-area: results;
        }

        .main-content {
            display: flex;
            flex-direction: column;
            gap: 2rem;
        }

        @media (min-width: 1024px) {
            .main-content {
                flex-direction: row;
            }
        }

        .calendar-container {
            flex: 1;
        }
        
        .calendar-wrapper {
             flex: 1;
             display: flex;
             flex-direction: column;
        }

        .controls-container {
            flex: 1;
        }

        .day {
            min-height: 3.5rem;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 0.5rem;
            cursor: pointer;
            transition: background-color 0.2s ease-in-out, transform 0.2s ease-in-out;
            font-size: 0.875rem;
            color: #d1d5db;
        }

        .day:hover:not(.empty-day) {
            transform: scale(1.05);
        }

        /* Vizuális módosítások a felhasználó kérése alapján */
        .day.selected {
            background-color: #1e40af;
            font-weight: 600;
            color: white;
        }

        .day.vacation {
            background-color: #f59e0b;
            font-weight: 600;
            color: white;
        }

        .day.overtime {
            border: 2px solid #dc2626;
        }
        
        .day.overtime-full {
             background-color: #991b1b;
             color: white;
             font-weight: 600;
        }

        .day.sick-leave {
            background-color: #14b8a6; /* Teal color */
            font-weight: 600;
            color: white;
        }

        .day span.hours {
            font-size: 0.75rem;
            color: #9ca3af;
            margin-top: 0.25rem;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 100;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(5px);
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background-color: rgba(31, 41, 55, 0.95);
            padding: 2rem;
            border-radius: 1rem;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
            width: 90%;
            max-width: 24rem;
            border: 1px solid #4b5563;
            position: relative;
        }

        /* Stílusok a bezárás gombhoz */
        .close-btn {
            position: absolute;
            top: 0.75rem;
            right: 0.75rem;
            font-size: 1.5rem;
            line-height: 1;
            color: #9ca3af;
            background: none;
            border: none;
            cursor: pointer;
            transition: color 0.2s;
            font-weight: bold;
        }

        .close-btn:hover {
            color: #e5e7eb;
        }

        .message-box {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 110;
            background-color: #1f2937;
            padding: 1.5rem;
            border-radius: 0.75rem;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
            text-align: center;
            border: 1px solid #4b5563;
        }

        .info-icon {
            cursor: help;
            color: #9ca3af;
            margin-left: 0.5rem;
            font-size: 1rem;
        }

        .disabled {
            opacity: 0.5;
            pointer-events: none;
        }

        .disabled-input {
            background-color: #4b5563;
            cursor: not-allowed;
        }

        #chart-container {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 300px;
        }
        
        .tooltip {
            position: absolute;
            background: #1f2937;
            padding: 8px 12px;
            border-radius: 6px;
            pointer-events: none;
            color: #fff;
            opacity: 0;
            transition: opacity 0.2s;
            z-index: 200;
            border: 1px solid #4b5563;
        }
        
        .bar {
            fill: #6d28d9;
            transition: fill 0.3s ease;
        }

        .bar:hover {
            fill: #8b5cf6;
        }

        .axis text {
            fill: #9ca3af;
        }

        .highlight-card {
            background: linear-gradient(135deg, #1f2937, #374151);
            position: relative;
            overflow: hidden;
            border: 1px solid #4b5563;
            animation: pulse-border 2s infinite cubic-bezier(0.68, -0.55, 0.27, 1.55);
        }

        @keyframes pulse-border {
            0% {
                box-shadow: 0 0 0 0 rgba(109, 40, 217, 0.4);
            }
            70% {
                box-shadow: 0 0 0 10px rgba(109, 40, 217, 0);
            }
            100% {
                box-shadow: 0 0 0 0 rgba(109, 40, 217, 0);
            }
        }
        
        .accordion-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease-out;
            background-color: rgba(17, 24, 39, 0.5);
            border-radius: 0.5rem;
        }
        .icon-btn {
            background-color: rgba(255,255,255,0.1);
            border-radius: 0.5rem;
            padding: 0.75rem;
            transition: background-color 0.2s;
        }
        .icon-btn:hover {
            background-color: rgba(255,255,255,0.2);
        }
    </style>
</head>
<body class="flex flex-col items-center justify-start py-8 px-4">
    <canvas id="futuristic-canvas"></canvas>
    <div class="container glass-panel rounded-2xl">
        <div class="header">
            <h1 class="text-3xl font-bold text-white">Fizetéskalkulátor</h1>
        </div>
        <div class="main-content">
            <div class="calendar-wrapper">
                 <!-- Profile Manager -->
                <div class="profile-manager p-4 bg-gray-900/50 rounded-lg">
                    <h3 class="text-lg font-semibold text-white mb-3">Profilok</h3>
                    <div class="space-y-3">
                         <div id="profile-display-view">
                            <label for="profileSelector" class="block text-gray-400 font-medium mb-1 text-sm">Aktív profil</label>
                            <div class="flex items-center space-x-2">
                                <select id="profileSelector" class="w-full p-3 bg-gray-800 text-white border border-gray-700 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500"></select>
                                <button id="editProfileBtn" class="icon-btn text-gray-300 hover:text-white">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M17.414 2.586a2 2 0 00-2.828 0L7 10.172V13h2.828l7.586-7.586a2 2 0 000-2.828z" /><path fill-rule="evenodd" d="M2 6a2 2 0 012-2h4a1 1 0 010 2H4v10h10v-4a1 1 0 112 0v4a2 2 0 01-2 2H4a2 2 0 01-2-2V6z" clip-rule="evenodd" /></svg>
                                </button>
                                <button id="deleteProfileBtn" class="icon-btn text-red-400 hover:text-red-300">
                                     <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm6 0a1 1 0 11-2 0v6a1 1 0 112 0V8z" clip-rule="evenodd" /></svg>
                                </button>
                            </div>
                        </div>
                        <div id="profile-edit-view" class="hidden">
                             <label for="editProfileNameInput" class="block text-gray-400 font-medium mb-1 text-sm">Profil átnevezése</label>
                            <div class="flex items-center space-x-2">
                                <input type="text" id="editProfileNameInput" class="w-full p-3 bg-gray-800 text-white border border-gray-700 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500">
                                <button id="saveProfileNameBtn" class="icon-btn text-green-400 hover:text-green-300">
                                   <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd" /></svg>
                                </button>
                                <button id="cancelEditProfileBtn" class="icon-btn text-gray-300 hover:text-white">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd" /></svg>
                                </button>
                            </div>
                        </div>
                        <div class="flex items-end space-x-2">
                            <div class="flex-grow">
                                <label for="newProfileName" class="block text-gray-400 font-medium mb-1 text-sm sr-only">Új profil neve</label>
                                <input type="text" id="newProfileName" placeholder="Új profil létrehozása..." class="w-full p-3 bg-gray-800 text-white border border-gray-700 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500">
                            </div>
                            <button id="addProfileBtn" class="p-3 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors duration-200">Hozzáad</button>
                        </div>
                    </div>
                </div>

                <!-- Template Manager -->
                <div class="template-manager mt-6 p-4 bg-gray-900/50 rounded-lg">
                    <h3 class="text-lg font-semibold text-white mb-3">Munkaidő Sablonok</h3>
                     <div class="space-y-3">
                        <label for="templateSelector" class="block text-gray-400 font-medium mb-1 text-sm">Mentett sablonok</label>
                        <div class="flex items-center space-x-2">
                            <select id="templateSelector" class="w-full p-3 bg-gray-800 text-white border border-gray-700 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500"></select>
                            <button id="editTemplateBtn" class="icon-btn text-gray-300 hover:text-white">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M17.414 2.586a2 2 0 00-2.828 0L7 10.172V13h2.828l7.586-7.586a2 2 0 000-2.828z" /><path fill-rule="evenodd" d="M2 6a2 2 0 012-2h4a1 1 0 010 2H4v10h10v-4a1 1 0 112 0v4a2 2 0 01-2 2H4a2 2 0 01-2-2V6z" clip-rule="evenodd" /></svg>
                            </button>
                            <button id="deleteTemplateBtn" class="icon-btn text-red-400 hover:text-red-300">
                                 <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm6 0a1 1 0 11-2 0v6a1 1 0 112 0V8z" clip-rule="evenodd" /></svg>
                            </button>
                        </div>
                        <button id="addTemplateBtn" class="w-full mt-2 p-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors duration-200">Új sablon létrehozása</button>
                    </div>
                </div>

                <div class="calendar-container mt-6">
                    <div class="flex items-center justify-between mb-4">
                        <button id="prevBtn" class="p-2 rounded-full bg-purple-600 text-white hover:bg-purple-700 transition-colors duration-200">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
                            </svg>
                        </button>
                        <h2 id="currentMonth" class="text-2xl font-bold text-white"></h2>
                        <button id="nextBtn" class="p-2 rounded-full bg-purple-600 text-white hover:bg-purple-700 transition-colors duration-200">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
                            </svg>
                        </button>
                    </div>
                    <div class="grid grid-cols-7 gap-1 text-center font-medium text-gray-400 text-sm">
                        <div class="p-2">H</div>
                        <div class="p-2">K</div>
                        <div class="p-2">Sze</div>
                        <div class="p-2">Cs</div>
                        <div class="p-2">P</div>
                        <div class="p-2">Szo</div>
                        <div class="p-2">V</div>
                    </div>
                    <div id="calendarDays" class="grid grid-cols-7 gap-1 text-center mt-2"></div>
                </div>

            </div>
            <div class="controls-container">
                <h2 class="text-2xl font-bold text-white mb-6">Beállítások</h2>
                <div class="space-y-6 pr-2">

                    <!-- Alapbérek Szekció -->
                    <div>
                        <h3 class="text-lg font-semibold text-white mb-3">Alapbérek</h3>
                        <div class="space-y-4 p-4 bg-gray-900/50 rounded-lg">
                            <div>
                                <label for="hourlyRate" class="block text-gray-400 font-medium mb-1 text-sm">Alap órabér (Ft)</label>
                                <input type="number" id="hourlyRate" class="w-full p-3 bg-gray-800 text-white border border-gray-700 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500">
                            </div>
                            <div>
                                <label for="vacationHourlyRate" class="block text-gray-400 font-medium mb-1 text-sm">Szabadság órabére (Ft)</label>
                                <input type="number" id="vacationHourlyRate" class="w-full p-3 bg-gray-800 text-white border border-gray-700 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500">
                            </div>
                        </div>
                    </div>
                    
                    <!-- Pótlékok Szekció (Accordion) -->
                    <div>
                        <button class="accordion-toggle w-full flex justify-between items-center text-left">
                            <h3 class="text-lg font-semibold text-white">Pótlékok</h3>
                            <svg class="chevron-icon w-5 h-5 text-gray-400 transition-transform duration-300" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                            </svg>
                        </button>
                        <div class="accordion-content mt-2">
                           <div class="p-4 space-y-4">
                                <hr class="border-gray-700">
                                <!-- Délutáni pótlék -->
                                <h4 class="font-semibold text-gray-300">Délutáni pótlék</h4>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div>
                                        <label class="block text-gray-400 font-medium mb-1 text-sm">Pótlék (%)</label>
                                        <input type="number" id="eveningRate" class="w-full p-3 bg-gray-800 text-white border border-gray-700 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500">
                                    </div>
                                    <div></div>
                                    <div>
                                        <label for="eveningStart" class="block text-gray-400 font-medium mb-1 text-sm">Kezdő óra</label>
                                        <input type="number" id="eveningStart" class="w-full p-3 bg-gray-800 text-white border border-gray-700 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500">
                                    </div>
                                    <div>
                                        <label for="eveningEnd" class="block text-gray-400 font-medium mb-1 text-sm">Befejező óra</label>
                                        <input type="number" id="eveningEnd" class="w-full p-3 bg-gray-800 text-white border border-gray-700 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500">
                                    </div>
                                </div>
                                <hr class="border-gray-700">
                                <!-- Éjszakai pótlék -->
                                <h4 class="font-semibold text-gray-300">Éjszakai pótlék</h4>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                     <div>
                                        <label class="block text-gray-400 font-medium mb-1 text-sm">Pótlék (%)</label>
                                        <input type="number" id="nightRate" class="w-full p-3 bg-gray-800 text-white border border-gray-700 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500">
                                    </div>
                                    <div></div>
                                    <div>
                                        <label for="nightStart" class="block text-gray-400 font-medium mb-1 text-sm">Kezdő óra</label>
                                        <input type="number" id="nightStart" class="w-full p-3 bg-gray-800 text-white border border-gray-700 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500">
                                    </div>
                                    <div>
                                        <label for="nightEnd" class="block text-gray-400 font-medium mb-1 text-sm">Befejező óra</label>
                                        <input type="number" id="nightEnd" class="w-full p-3 bg-gray-800 text-white border border-gray-700 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500">
                                    </div>
                                </div>
                                <hr class="border-gray-700">
                                <!-- Hétvégi pótlék -->
                                <h4 class="font-semibold text-gray-300">Hétvégi pótlék</h4>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div>
                                        <label class="block text-gray-400 font-medium mb-1 text-sm">Pótlék (%)</label>
                                        <input type="number" id="weekendRate" class="w-full p-3 bg-gray-800 text-white border border-gray-700 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500">
                                    </div>
                                     <div>
                                        <label for="weekendOption" class="block text-gray-400 font-medium mb-1 text-sm">Napok</label>
                                        <select id="weekendOption" class="w-full p-3 bg-gray-800 text-white border border-gray-700 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500">
                                            <option value="all">Szombat és Vasárnap</option>
                                            <option value="saturday">Szombat</option>
                                            <option value="sunday">Vasárnap</option>
                                        </select>
                                    </div>
                                </div>
                           </div>
                        </div>
                    </div>

                    <!-- Bejárás Támogatás Szekció -->
                    <div>
                        <h3 class="text-lg font-semibold text-white mb-3">Bejárás Támogatás</h3>
                        <div class="space-y-4 p-4 bg-gray-900/50 rounded-lg">
                            <div class="flex space-x-4">
                                <label class="flex items-center text-gray-300">
                                    <input type="radio" name="travelAllowanceType" value="none" class="mr-2 text-purple-500 focus:ring-purple-500" checked>
                                    Nincs
                                </label>
                                <label class="flex items-center text-gray-300">
                                    <input type="radio" name="travelAllowanceType" value="pass" class="mr-2 text-purple-500 focus:ring-purple-500">
                                    Bérlet
                                </label>
                                <label class="flex items-center text-gray-300">
                                    <input type="radio" name="travelAllowanceType" value="fuel" class="mr-2 text-purple-500 focus:ring-purple-500">
                                    Benzinpénz
                                </label>
                            </div>
                            <div id="pass-inputs" class="hidden space-y-2">
                                <label for="passAmount" class="block text-gray-400 font-medium text-sm">Bérlet összege (Ft)</label>
                                <input type="number" id="passAmount" class="w-full p-3 bg-gray-800 text-white border border-gray-700 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500">
                            </div>
                            <div id="fuel-inputs" class="hidden grid grid-cols-2 gap-4">
                                <div>
                                    <label for="tripDistance" class="block text-gray-400 font-medium text-sm">Távolság egy útra (km)</label>
                                    <input type="number" id="tripDistance" class="w-full p-3 bg-gray-800 text-white border border-gray-700 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500">
                                </div>
                                <div>
                                    <label for="kmCost" class="block text-gray-400 font-medium text-sm">Költségtérítés (Ft/km)</label>
                                    <input type="number" id="kmCost" class="w-full p-3 bg-gray-800 text-white border border-gray-700 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500">
                                </div>
                            </div>
                        </div>
                    </div>


                    <!-- Juttatások Szekció -->
                    <div>
                        <h3 class="text-lg font-semibold text-white mb-3">Juttatások</h3>
                        <div class="space-y-4 p-4 bg-gray-900/50 rounded-lg">
                            <div id="benefits-container" class="space-y-4"></div>
                            <button id="addBenefitBtn" class="w-full bg-blue-600 text-white font-bold p-3 rounded-lg hover:bg-blue-700 transition-colors duration-200">
                                Új juttatás hozzáadása
                            </button>
                        </div>
                    </div>

                    <!-- Adókedvezmények Szekció -->
                    <div>
                        <h3 class="text-lg font-semibold text-white mb-3">Adókedvezmények</h3>
                        <div class="space-y-2 text-gray-300 p-4 bg-gray-900/50 rounded-lg">
                            <div class="flex items-center">
                                <label class="flex items-center">
                                    <input type="checkbox" id="ekho" class="rounded text-purple-500 focus:ring-purple-500 mr-2 bg-gray-700 border-gray-600">
                                    <span>EKHO adózás</span>
                                </label>
                                <button class="info-icon" data-info="ekho">i</button>
                            </div>
                            <div class="flex items-center">
                                <label class="flex items-center">
                                    <input type="checkbox" id="under25" class="rounded text-purple-500 focus:ring-purple-500 mr-2 bg-gray-700 border-gray-600">
                                    <span>25 év alatti adómentesség</span>
                                </label>
                                <button class="info-icon" data-info="under25">i</button>
                            </div>
                            <div class="flex items-center">
                                <label class="flex items-center">
                                    <input type="checkbox" id="under30mother" class="rounded text-purple-500 focus:ring-purple-500 mr-2 bg-gray-700 border-gray-600">
                                    <span>30 év alatti anyuka</span>
                                </label>
                                <button class="info-icon" data-info="under30mother">i</button>
                            </div>
                            <div class="flex items-center">
                                <label class="flex items-center">
                                    <input type="checkbox" id="married" class="rounded text-purple-500 focus:ring-purple-500 mr-2 bg-gray-700 border-gray-600">
                                    <span>Friss házasok</span>
                                </label>
                                <button class="info-icon" data-info="married">i</button>
                            </div>
                            <div class="flex items-center">
                                <label class="flex items-center">
                                    <input type="checkbox" id="personalDeduction" class="rounded text-purple-500 focus:ring-purple-500 mr-2 bg-gray-700 border-gray-600">
                                    <span>Személyi kedvezmény</span>
                                </label>
                                <button class="info-icon" data-info="personalDeduction">i</button>
                            </div>
                            <div class="flex items-center">
                                <label class="flex items-center">
                                    <input type="checkbox" id="retiredEmployee" class="rounded text-purple-500 focus:ring-purple-500 mr-2 bg-gray-700 border-gray-600">
                                    <span>Nyugdíjas munkavállaló</span>
                                </label>
                                <button class="info-icon" data-info="retiredEmployee">i</button>
                            </div>
                            <div class="flex items-center">
                                <label class="flex items-center">
                                    <input type="checkbox" id="mother4plus" class="rounded text-purple-500 focus:ring-purple-500 mr-2 bg-gray-700 border-gray-600">
                                    <span>4+ gyermeket nevelő anyák</span>
                                </label>
                                <button class="info-icon" data-info="mother4plus">i</button>
                            </div>
                        </div>
                    </div>

                    <button id="calculateBtn" class="w-full bg-green-600 text-white font-bold p-3 rounded-lg hover:bg-green-700 transition-colors duration-200 mt-4">
                        Számítás indítása
                    </button>
                </div>
            </div>
        </div>
        <div class="results-container">
            <h2 class="text-2xl font-bold text-white mb-6">Összesítés</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                <div class="bg-gray-800 p-4 rounded-lg">
                    <p class="text-gray-400 font-medium">Összes munkaóra:</p>
                    <p id="totalHours" class="text-xl font-bold text-white mt-1">0 óra</p>
                </div>
                <div class="bg-gray-800 p-4 rounded-lg">
                    <p class="text-gray-400 font-medium">Alap bruttó:</p>
                    <p id="baseBrutto" class="text-xl font-bold text-white mt-1">0 Ft</p>
                </div>
                <div class="bg-gray-800 p-4 rounded-lg">
                    <p class="text-gray-400 font-medium">Éjszakai pótlék:</p>
                    <p id="nightBreakdown" class="text-xl font-bold text-white mt-1">0 óra (0 Ft)</p>
                </div>
                <div class="bg-gray-800 p-4 rounded-lg">
                    <p class="text-gray-400 font-medium">Délutáni pótlék:</p>
                    <p id="eveningBreakdown" class="text-xl font-bold text-white mt-1">0 óra (0 Ft)</p>
                </div>
                <div class="bg-gray-800 p-4 rounded-lg">
                    <p class="text-gray-400 font-medium">Hétvégi pótlék:</p>
                    <p id="weekendBreakdown" class="text-xl font-bold text-white mt-1">0 óra (0 Ft)</p>
                </div>
                <div class="bg-gray-800 p-4 rounded-lg">
                    <p class="text-gray-400 font-medium">Túlóra pótlék:</p>
                    <p id="overtimeBreakdown" class="text-xl font-bold text-white mt-1">0 óra (0 Ft)</p>
                </div>
                <div class="bg-gray-800 p-4 rounded-lg">
                    <p class="text-gray-400 font-medium">Szabadságidő:</p>
                    <p id="vacationHours" class="text-xl font-bold text-white mt-1">0 óra (0 Ft)</p>
                </div>
                 <div class="bg-gray-800 p-4 rounded-lg">
                    <p class="text-gray-400 font-medium">Táppénz:</p>
                    <p id="sickLeaveBreakdown" class="text-xl font-bold text-white mt-1">0 óra (0 Ft)</p>
                </div>
                <div id="travelAllowance-container" class="bg-gray-800 p-4 rounded-lg hidden">
                    <p class="text-gray-400 font-medium">Bejárási támogatás:</p>
                    <p id="travelAllowanceBreakdown" class="text-xl font-bold text-white mt-1">0 Ft</p>
                </div>
                <div id="totalBenefits-container" class="bg-gray-800 p-4 rounded-lg">
                    <p class="text-gray-400 font-medium">Összes juttatás:</p>
                    <p id="totalBenefits" class="text-xl font-bold text-white mt-1">0 Ft</p>
                </div>
                <div class="bg-purple-600 text-white p-4 rounded-lg col-span-1 md:col-span-2 lg:col-span-3 text-center highlight-card">
                    <p class="font-medium">Várható Nettó Fizetés:</p>
                    <p id="nettoOutput" class="text-3xl font-bold mt-1">0 Ft</p>
                </div>
            </div>
            <div id="savings-breakdown-container" class="mt-8 bg-gray-800 p-4 rounded-lg">
                <h3 class="text-xl font-bold text-white mb-4">Megtakarítási részletező</h3>
                <div id="savings-list" class="space-y-2">
                    <p class="text-gray-400" id="savings-placeholder">Jelölj be kedvezményeket a részletekhez.</p>
                </div>
                <div class="mt-4 border-t border-gray-700 pt-4">
                    <p class="font-medium text-gray-400">Teljes megtakarítás:</p>
                    <p id="totalSavings" class="text-2xl font-bold text-green-400 mt-1">0 Ft</p>
                </div>
            </div>
            <div id="chart-panel" class="mt-8 bg-gray-800 p-4 rounded-lg">
                <h3 class="text-xl font-bold text-white mb-4">Bruttó Fizetés Megoszlása</h3>
                <div id="chart-container"></div>
            </div>
        </div>
        <div class="mt-8 pt-4 border-t border-gray-700 text-center text-xs text-gray-500">
            <p>&copy; 2024 Korki32</p>
        </div>
    </div>
    <div id="shiftModal" class="modal">
        <div class="modal-content text-white">
            <button class="close-btn" onclick="document.getElementById('shiftModal').style.display='none';">&times;</button>
            <h3 class="text-xl font-bold mb-4">Munkaidő megadása</h3>
            <div class="mb-4">
                <label for="templateSelectorModal" class="block text-gray-400 font-medium mb-1 text-sm">Sablon választása</label>
                <select id="templateSelectorModal" class="w-full p-3 bg-gray-800 text-white border border-gray-700 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500">
                    <option value="">-- Egyéni beállítás --</option>
                </select>
            </div>
            <div id="shift-inputs" class="space-y-4 mb-4">
                <div>
                    <label for="startTime" class="block text-gray-400 font-medium mb-1">Kezdő óra</label>
                    <input type="time" id="startTime" class="w-full p-3 bg-gray-700 border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500">
                </div>
                <div>
                    <label for="endTime" class="block text-gray-400 font-medium mb-1">Befejező óra</label>
                    <input type="time" id="endTime" class="w-full p-3 bg-gray-700 border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500">
                </div>
            </div>
            <div class="flex flex-col space-y-3">
                 <div class="flex flex-col space-y-2 overtime-container">
                    <div class="flex items-center justify-between">
                         <label for="overtimeCheckbox" class="flex items-center">
                            <input type="checkbox" id="overtimeCheckbox" class="rounded text-purple-500 mr-2 bg-gray-700 border-gray-600">
                            <span class="font-medium">Túlóra</span>
                        </label>
                    </div>
                    <div id="overtime-inputs" class="hidden space-y-2 pl-6">
                         <div>
                            <label for="overtimeStartTime" class="block text-gray-400 font-medium mb-1 text-sm">Túlóra kezdete</label>
                            <input type="time" id="overtimeStartTime" class="w-full p-2 bg-gray-700 border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500">
                        </div>
                        <div>
                            <label for="overtimeEndTime" class="block text-gray-400 font-medium mb-1 text-sm">Túlóra vége</label>
                            <input type="time" id="overtimeEndTime" class="w-full p-2 bg-gray-700 border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500">
                        </div>
                        <div>
                            <label for="overtimeRateInputModal" class="block text-gray-400 font-medium mb-1 text-sm">Túlóra pótlék (%)</label>
                            <input type="number" id="overtimeRateInputModal" value="50" class="w-full p-2 bg-gray-700 border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500">
                        </div>
                    </div>
                </div>
                <div class="flex items-center justify-between vacation-container">
                    <label for="vacationCheckbox" class="flex items-center">
                        <input type="checkbox" id="vacationCheckbox" class="rounded text-purple-500 mr-2 bg-gray-700 border-gray-600">
                        <span class="font-medium">Szabadság</span>
                    </label>
                    <div class="flex items-center">
                        <input type="number" id="vacationHoursInput" value="8" class="w-20 p-2 bg-gray-700 border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500 text-right">
                        <span class="ml-2 w-8 text-gray-400">óra</span>
                    </div>
                </div>
                <div class="flex items-center justify-between sick-leave-container">
                    <label for="sickLeaveCheckbox" class="flex items-center">
                        <input type="checkbox" id="sickLeaveCheckbox" class="rounded text-purple-500 mr-2 bg-gray-700 border-gray-600">
                        <span class="font-medium">Táppénz</span>
                    </label>
                    <div class="flex items-center space-x-2">
                        <input type="number" id="sickLeaveHoursInput" value="8" class="w-16 p-2 bg-gray-700 border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500 text-right">
                        <span class="-ml-1 text-gray-400">óra</span>
                        <input type="number" id="sickLeavePercentInput" value="70" class="w-16 p-2 bg-gray-700 border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500 text-right">
                        <span class="-ml-1 text-gray-400">%</span>
                    </div>
                </div>
            </div>
            <div class="flex justify-between space-x-2 mt-6">
                <button id="saveShiftBtn" class="w-full bg-green-600 text-white font-bold p-3 rounded-lg hover:bg-green-700 transition-colors duration-200">Mentés</button>
                <button id="cancelShiftBtn" class="w-full bg-red-600 text-white font-bold p-3 rounded-lg hover:bg-red-700 transition-colors duration-200">Törlés</button>
            </div>
        </div>
    </div>

    <!-- Template Modal -->
    <div id="templateModal" class="modal">
        <div class="modal-content text-white">
            <button class="close-btn" onclick="document.getElementById('templateModal').style.display='none';">&times;</button>
            <h3 id="templateModalTitle" class="text-xl font-bold mb-4">Sablon létrehozása</h3>
            <div class="space-y-4">
                <div>
                    <label for="templateNameInput" class="block text-gray-400 font-medium mb-1">Sablon neve</label>
                    <input type="text" id="templateNameInput" class="w-full p-3 bg-gray-700 border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500">
                </div>
                <hr class="border-gray-600">
                <div id="template-shift-inputs" class="space-y-4">
                    <div>
                        <label for="templateStartTime" class="block text-gray-400 font-medium mb-1">Kezdő óra</label>
                        <input type="time" id="templateStartTime" class="w-full p-3 bg-gray-700 border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500">
                    </div>
                    <div>
                        <label for="templateEndTime" class="block text-gray-400 font-medium mb-1">Befejező óra</label>
                        <input type="time" id="templateEndTime" class="w-full p-3 bg-gray-700 border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500">
                    </div>
                </div>
                <div class="flex flex-col space-y-3">
                     <div class="flex flex-col space-y-2">
                        <label for="templateOvertimeCheckbox" class="flex items-center">
                            <input type="checkbox" id="templateOvertimeCheckbox" class="rounded text-purple-500 mr-2 bg-gray-700 border-gray-600">
                            <span class="font-medium">Túlóra</span>
                        </label>
                        <div id="template-overtime-inputs" class="hidden space-y-2 pl-6">
                             <div>
                                <label for="templateOvertimeStartTime" class="block text-gray-400 font-medium mb-1 text-sm">Túlóra kezdete</label>
                                <input type="time" id="templateOvertimeStartTime" class="w-full p-2 bg-gray-700 border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500">
                            </div>
                            <div>
                                <label for="templateOvertimeEndTime" class="block text-gray-400 font-medium mb-1 text-sm">Túlóra vége</label>
                                <input type="time" id="templateOvertimeEndTime" class="w-full p-2 bg-gray-700 border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500">
                            </div>
                            <div>
                                <label for="templateOvertimeRate" class="block text-gray-400 font-medium mb-1 text-sm">Túlóra pótlék (%)</label>
                                <input type="number" id="templateOvertimeRate" value="50" class="w-full p-2 bg-gray-700 border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500">
                            </div>
                        </div>
                    </div>
                    <div class="flex items-center justify-between">
                        <label for="templateVacationCheckbox" class="flex items-center">
                            <input type="checkbox" id="templateVacationCheckbox" class="rounded text-purple-500 mr-2 bg-gray-700 border-gray-600">
                            <span class="font-medium">Szabadság</span>
                        </label>
                        <div class="flex items-center">
                            <input type="number" id="templateVacationHours" value="8" class="w-20 p-2 bg-gray-700 border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500 text-right">
                            <span class="ml-2 w-8 text-gray-400">óra</span>
                        </div>
                    </div>
                    <div class="flex items-center justify-between">
                        <label for="templateSickLeaveCheckbox" class="flex items-center">
                            <input type="checkbox" id="templateSickLeaveCheckbox" class="rounded text-purple-500 mr-2 bg-gray-700 border-gray-600">
                            <span class="font-medium">Táppénz</span>
                        </label>
                        <div class="flex items-center space-x-2">
                            <input type="number" id="templateSickLeaveHours" value="8" class="w-16 p-2 bg-gray-700 border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500 text-right">
                            <span class="-ml-1 text-gray-400">óra</span>
                            <input type="number" id="templateSickLeavePercent" value="70" class="w-16 p-2 bg-gray-700 border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500 text-right">
                            <span class="-ml-1 text-gray-400">%</span>
                        </div>
                    </div>
                </div>
                <div class="flex justify-end space-x-2 mt-6">
                    <button id="saveTemplateBtn" class="bg-green-600 text-white font-bold p-3 rounded-lg hover:bg-green-700 transition-colors duration-200">Sablon mentése</button>
                </div>
            </div>
        </div>
    </div>


    <div id="pdfConfirmModal" class="modal">
        <div class="modal-content text-white text-center">
            <button class="close-btn" onclick="document.getElementById('pdfConfirmModal').style.display='none';">&times;</button>
            <h3 class="text-xl font-bold mb-4">Adatok mentése</h3>
            <p class="mb-6">Szeretnéd elmenteni a havi adatokat PDF-be, mielőtt új hónapra váltasz?</p>
            <div class="flex justify-center space-x-4">
                <button id="saveAndContinueBtn" class="bg-green-600 text-white font-bold p-3 rounded-lg hover:bg-green-700 transition-colors duration-200">Igen, mentés</button>
                <button id="continueWithoutSavingBtn" class="bg-red-600 text-white font-bold p-3 rounded-lg hover:bg-red-700 transition-colors duration-200">Nem, folytatás</button>
            </div>
        </div>
    </div>
    <div id="messageBox" class="message-box text-white">
        <p id="messageText" class="text-lg font-medium mb-4"></p>
        <button id="closeMessageBtn" class="bg-purple-600 px-4 py-2 rounded-lg hover:bg-purple-700 transition-colors duration-200">OK</button>
    </div>
    <div id="tooltip" class="tooltip"></div>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const canvas = document.getElementById('futuristic-canvas');
            const ctx = canvas.getContext('2d');
            let width, height;
            let particles = [];
            const particleCount = 200;
            function resizeCanvas() {
                width = canvas.width = window.innerWidth;
                height = canvas.height = window.innerHeight;
            }

            class Particle {
                constructor() {
                    this.x = Math.random() * width;
                    this.y = Math.random() * height;
                    this.vx = (Math.random() - 0.5) * 0.2;
                    this.vy = (Math.random() - 0.5) * 0.2;
                    this.radius = Math.random() * 1.5;
                    this.color = `rgba(44, 192, 235, ${Math.random() * 0.5 + 0.1})`;
                }

                update() {
                    this.x += this.vx;
                    this.y += this.vy;
                    if (this.x < 0 || this.x > width) this.vx *= -1;
                    if (this.y < 0 || this.y > height) this.vy *= -1;
                }

                draw() {
                    ctx.beginPath();
                    ctx.arc(this.x, this.y, this.radius, 0, Math.PI * 2);
                    ctx.fillStyle = this.color;
                    ctx.fill();
                }
            }

            function initParticles() {
                particles = [];
                for (let i = 0; i < particleCount; i++) {
                    particles.push(new Particle());
                }
            }

            function animate() {
                ctx.clearRect(0, 0, width, height);
                particles.forEach(p => {
                    p.update();
                    p.draw();
                });
                for (let i = 0; i < particles.length; i++) {
                    for (let j = i + 1; j < particles.length; j++) {
                        const dx = particles[i].x - particles[j].x;
                        const dy = particles[i].y - particles[j].y;
                        const distance = Math.sqrt(dx * dx + dy * dy);
                        if (distance < 100) {
                            ctx.beginPath();
                            ctx.moveTo(particles[i].x, particles[i].y);
                            ctx.lineTo(particles[j].x, particles[j].y);
                            ctx.strokeStyle = `rgba(44, 192, 235, ${1 - distance / 100})`;
                            ctx.lineWidth = 0.2;
                            ctx.stroke();
                        }
                    }
                }
                requestAnimationFrame(animate);
            }

            resizeCanvas();
            initParticles();
            window.addEventListener('resize', resizeCanvas);
            animate();
            // Calculator logic starts here
            const calendarDaysEl = document.getElementById('calendarDays');
            const currentMonthEl = document.getElementById('currentMonth');
            const prevBtn = document.getElementById('prevBtn');
            const nextBtn = document.getElementById('nextBtn');
            const hourlyRateInput = document.getElementById('hourlyRate');
            const vacationHourlyRateInput = document.getElementById('vacationHourlyRate');
            const nightRateInput = document.getElementById('nightRate');
            const nightStartInput = document.getElementById('nightStart');
            const nightEndInput = document.getElementById('nightEnd');
            const eveningRateInput = document.getElementById('eveningRate');
            const eveningStartInput = document.getElementById('eveningStart');
            const eveningEndInput = document.getElementById('eveningEnd');
            const weekendRateInput = document.getElementById('weekendRate');
            const weekendOptionSelect = document.getElementById('weekendOption');
            const ekhoCheckbox = document.getElementById('ekho');
            const under25Checkbox = document.getElementById('under25');
            const under30motherCheckbox = document.getElementById('under30mother');
            const marriedCheckbox = document.getElementById('married');
            const personalDeductionCheckbox = document.getElementById('personalDeduction');
            const retiredEmployeeCheckbox = document.getElementById('retiredEmployee');
            const mother4plusCheckbox = document.getElementById('mother4plus');
            const calculateBtn = document.getElementById('calculateBtn');
            const totalHoursEl = document.getElementById('totalHours');
            const baseBruttoEl = document.getElementById('baseBrutto');
            const nightBreakdownEl = document.getElementById('nightBreakdown');
            const eveningBreakdownEl = document.getElementById('eveningBreakdown');
            const weekendBreakdownEl = document.getElementById('weekendBreakdown');
            const overtimeBreakdownEl = document.getElementById('overtimeBreakdown');
            const vacationHoursEl = document.getElementById('vacationHours');
            const nettoOutputEl = document.getElementById('nettoOutput');
            const totalBenefitsEl = document.getElementById('totalBenefits');
            const totalBenefitsContainer = document.getElementById('totalBenefits-container');
            const totalSavingsEl = document.getElementById('totalSavings');
            const savingsListEl = document.getElementById('savings-list');
            const savingsPlaceholderEl = document.getElementById('savings-placeholder');
            const shiftModal = document.getElementById('shiftModal');
            const shiftInputs = document.getElementById('shift-inputs');
            const startTimeInput = document.getElementById('startTime');
            const endTimeInput = document.getElementById('endTime');
            const overtimeCheckbox = document.getElementById('overtimeCheckbox');
            const overtimeInputsContainer = document.getElementById('overtime-inputs');
            const overtimeStartTimeInput = document.getElementById('overtimeStartTime');
            const overtimeEndTimeInput = document.getElementById('overtimeEndTime');
            const overtimeRateInputModal = document.getElementById('overtimeRateInputModal');
            const vacationCheckbox = document.getElementById('vacationCheckbox');
            const vacationHoursInput = document.getElementById('vacationHoursInput');
            const saveShiftBtn = document.getElementById('saveShiftBtn');
            const cancelShiftBtn = document.getElementById('cancelShiftBtn');
            const messageBox = document.getElementById('messageBox');
            const messageText = document.getElementById('messageText');
            const closeMessageBtn = document.getElementById('closeMessageBtn');
            const infoButtons = document.querySelectorAll('.info-icon');
            const pdfConfirmModal = document.getElementById('pdfConfirmModal');
            const saveAndContinueBtn = document.getElementById('saveAndContinueBtn');
            const continueWithoutSavingBtn = document.getElementById('continueWithoutSavingBtn');
            const closePdfModalBtn = document.querySelector('#pdfConfirmModal .close-btn');
            const sickLeaveCheckbox = document.getElementById('sickLeaveCheckbox');
            const sickLeaveHoursInput = document.getElementById('sickLeaveHoursInput');
            const sickLeavePercentInput = document.getElementById('sickLeavePercentInput');
            const sickLeaveBreakdownEl = document.getElementById('sickLeaveBreakdown');
            
            // Profile UI elements
            const profileSelector = document.getElementById('profileSelector');
            const newProfileNameInput = document.getElementById('newProfileName');
            const addProfileBtn = document.getElementById('addProfileBtn');
            const deleteProfileBtn = document.getElementById('deleteProfileBtn');
            const editProfileBtn = document.getElementById('editProfileBtn');
            const profileDisplayView = document.getElementById('profile-display-view');
            const profileEditView = document.getElementById('profile-edit-view');
            const editProfileNameInput = document.getElementById('editProfileNameInput');
            const saveProfileNameBtn = document.getElementById('saveProfileNameBtn');
            const cancelEditProfileBtn = document.getElementById('cancelEditProfileBtn');

            // Template UI elements
            const templateSelector = document.getElementById('templateSelector');
            const addTemplateBtn = document.getElementById('addTemplateBtn');
            const editTemplateBtn = document.getElementById('editTemplateBtn');
            const deleteTemplateBtn = document.getElementById('deleteTemplateBtn');
            const templateModal = document.getElementById('templateModal');
            const templateModalTitle = document.getElementById('templateModalTitle');
            const templateNameInput = document.getElementById('templateNameInput');
            const saveTemplateBtn = document.getElementById('saveTemplateBtn');
            const templateSelectorModal = document.getElementById('templateSelectorModal');
            
            // Travel Allowance UI elements
            const travelAllowanceRadios = document.querySelectorAll('input[name="travelAllowanceType"]');
            const passInputsContainer = document.getElementById('pass-inputs');
            const fuelInputsContainer = document.getElementById('fuel-inputs');
            const passAmountInput = document.getElementById('passAmount');
            const tripDistanceInput = document.getElementById('tripDistance');
            const kmCostInput = document.getElementById('kmCost');
            const travelAllowanceBreakdownEl = document.getElementById('travelAllowanceBreakdown');
            const travelAllowanceContainer = document.getElementById('travelAllowance-container');


            // Template Modal Inputs
            const templateStartTime = document.getElementById('templateStartTime');
            const templateEndTime = document.getElementById('templateEndTime');
            const templateOvertimeCheckbox = document.getElementById('templateOvertimeCheckbox');
            const templateOvertimeInputs = document.getElementById('template-overtime-inputs');
            const templateOvertimeStartTime = document.getElementById('templateOvertimeStartTime');
            const templateOvertimeEndTime = document.getElementById('templateOvertimeEndTime');
            const templateOvertimeRate = document.getElementById('templateOvertimeRate');
            const templateVacationCheckbox = document.getElementById('templateVacationCheckbox');
            const templateVacationHours = document.getElementById('templateVacationHours');
            const templateSickLeaveCheckbox = document.getElementById('templateSickLeaveCheckbox');
            const templateSickLeaveHours = document.getElementById('templateSickLeaveHours');
            const templateSickLeavePercent = document.getElementById('templateSickLeavePercent');

            let activeProfile = 'Default';
            let profiles = ['Default'];
            let shiftTemplates = {};
            let editingTemplateName = null;

            // Accordion logic
            const accordionToggles = document.querySelectorAll('.accordion-toggle');
            accordionToggles.forEach(button => {
                button.addEventListener('click', () => {
                    const content = button.nextElementSibling;
                    const icon = button.querySelector('.chevron-icon');

                    if (content.style.maxHeight) {
                        content.style.maxHeight = null;
                        icon.style.transform = 'rotate(0deg)';
                    } else {
                        content.style.maxHeight = content.scrollHeight + "px";
                        icon.style.transform = 'rotate(180deg)';
                    }
                });
            });

            const benefitsContainer = document.getElementById('benefits-container');
            const addBenefitBtn = document.getElementById('addBenefitBtn');

            let benefits = {};
            let benefitCounter = 0;

            const settingsInputs = [
                hourlyRateInput,
                vacationHourlyRateInput,
                nightRateInput,
                nightStartInput,
                nightEndInput,
                eveningRateInput,
                eveningStartInput,
                eveningEndInput,
                weekendRateInput,
                weekendOptionSelect,
                passAmountInput,
                tripDistanceInput,
                kmCostInput
            ];
            const settingsCheckboxes = [
                ekhoCheckbox,
                under25Checkbox,
                under30motherCheckbox,
                marriedCheckbox,
                personalDeductionCheckbox,
                retiredEmployeeCheckbox,
                mother4plusCheckbox,
            ];

            let currentDate = new Date();
            let selectedDays = {};
            let activeDate = null;
            let monthChangeDirection = 0; // -1: prev, 1: next

            const formatCurrency = (amount) => {
                return `${Math.round(amount).toLocaleString('hu-HU')} Ft`;
            };

            const showMessageBox = (message) => {
                messageText.textContent = message;
                messageBox.style.display = 'block';
            };

            const hideMessageBox = () => {
                messageBox.style.display = 'none';
            };
            closeMessageBtn.addEventListener('click', hideMessageBox);

            infoButtons.forEach(button => {
                button.addEventListener('click', (e) => {
                    const infoType = e.target.dataset.info;
                    let message = "";
                    switch (infoType) {
                        case 'ekho': message = "Az Egyszerűsített Közteherviselési Hozzájárulás (EKHO) egy adózási mód, amely helyettesíti a normál SZJA-t és a legtöbb járulékot."; break;
                        case 'under25': message = "A 25 év alattiak mentesülnek a személyi jövedelemadó (SZJA) fizetése alól a bruttó átlagkereset mértékéig."; break;
                        case 'under30mother': message = "A 30 év alatti, gyermeket vállaló anyák adómentességet kapnak a fizetésükre a bruttó átlagkereset mértékéig."; break;
                        case 'married': message = "A friss házasok havonta adóalap-kedvezményt vehetnek igénybe a házasságkötést követő 24 hónapon keresztül."; break;
                        case 'personalDeduction': message = "A személyi kedvezményre jogosító betegségekkel élők adóalap-kedvezményt vehetnek igénybe."; break;
                        case 'retiredEmployee': message = "A nyugdíjas munkavállalók mentesülnek a 18.5%-os TB-járulék fizetése alól, csak a 15%-os SZJA-t kell fizetniük."; break;
                        case 'mother4plus': message = "A 4 vagy több gyermeket nevelő anyák teljes mértékben mentesülnek a személyi jövedelemadó (SZJA) fizetése alól."; break;
                    }
                    showMessageBox(message);
                });
            });

            const createBenefitField = (id, name, value) => {
                const benefitDiv = document.createElement('div');
                benefitDiv.classList.add('flex', 'items-end', 'space-x-2', 'benefit-field');
                benefitDiv.dataset.id = id;

                benefitDiv.innerHTML = `
                    <div class="flex-1">
                        <label for="benefitName-${id}" class="block text-gray-400 font-medium mb-1 text-sm">Juttatás neve</label>
                        <input type="text" id="benefitName-${id}" value="${name || ''}" class="w-full p-3 bg-gray-800 text-white border border-gray-700 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500">
                    </div>
                    <div class="flex-1">
                        <label for="benefitValue-${id}" class="block text-gray-400 font-medium mb-1 text-sm">Összeg (Ft)</label>
                        <input type="number" id="benefitValue-${id}" value="${value || 0}" class="w-full p-3 bg-gray-800 text-white border border-gray-700 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500">
                    </div>
                    <button class="remove-benefit-btn p-3 bg-red-600 text-white rounded-lg hover:bg-red-700 transition-colors duration-200">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm6 0a1 1 0 11-2 0v6a1 1 0 112 0V8z" clip-rule="evenodd" />
                        </svg>
                    </button>
                `;
                benefitsContainer.appendChild(benefitDiv);
            };

            addBenefitBtn.addEventListener('click', () => {
                benefitCounter++;
                createBenefitField(benefitCounter, '', 0);
                saveSettings();
            });

            benefitsContainer.addEventListener('click', (e) => {
                if (e.target.closest('.remove-benefit-btn')) {
                    const benefitDiv = e.target.closest('.benefit-field');
                    const id = benefitDiv.dataset.id;
                    delete benefits[id];
                    benefitDiv.remove();
                    saveSettings();
                    calculate();
                }
            });


            const loadSettings = () => {
                const settings = JSON.parse(localStorage.getItem(`calculatorSettings_${activeProfile}`));
                
                benefitsContainer.innerHTML = '';
                benefitCounter = 0;
                
                if (settings) {
                    settingsInputs.forEach(input => {
                        if (settings[input.id] !== undefined) {
                            input.value = settings[input.id];
                        }
                    });
                    settingsCheckboxes.forEach(checkbox => {
                        if (settings[checkbox.id] !== undefined) {
                            checkbox.checked = settings[checkbox.id];
                        }
                    });

                    const travelType = settings.travelAllowanceType || 'none';
                    document.querySelector(`input[name="travelAllowanceType"][value="${travelType}"]`).checked = true;
                    handleTravelAllowanceChange();


                    benefits = settings.benefits || {};
                    Object.keys(benefits).forEach(id => {
                        createBenefitField(id, benefits[id].name, benefits[id].value);
                    });

                    if (Object.keys(benefits).length > 0) {
                        benefitCounter = Math.max(...Object.keys(benefits).map(id => parseInt(id)))
                    }

                } else {
                    // Alapértelmezett értékek beállítása
                    settingsInputs.forEach(input => input.value = '');
                    settingsCheckboxes.forEach(checkbox => checkbox.checked = false);
                    hourlyRateInput.value = 1500;
                    vacationHourlyRateInput.value = 1500;
                    nightRateInput.value = 25;
                    nightStartInput.value = 22;
                    nightEndInput.value = 6;
                    eveningRateInput.value = 15;
                    eveningStartInput.value = 18;
                    eveningEndInput.value = 22;
                    weekendRateInput.value = 50;
                    weekendOptionSelect.value = 'all';
                }
            };


            const saveSettings = () => {
                const settings = {};
                settingsInputs.forEach(input => {
                    settings[input.id] = input.value;
                });
                settingsCheckboxes.forEach(checkbox => {
                    settings[checkbox.id] = checkbox.checked;
                });
                
                const selectedTravelRadio = document.querySelector('input[name="travelAllowanceType"]:checked');
                settings.travelAllowanceType = selectedTravelRadio ? selectedTravelRadio.value : 'none';


                const benefitsData = {};
                document.querySelectorAll('.benefit-field').forEach(div => {
                    const id = div.dataset.id;
                    const nameInput = document.getElementById(`benefitName-${id}`);
                    const valueInput = document.getElementById(`benefitValue-${id}`);
                    benefitsData[id] = {
                        name: nameInput.value,
                        value: parseFloat(valueInput.value) || 0
                    };
                });
                settings.benefits = benefitsData;
                localStorage.setItem(`calculatorSettings_${activeProfile}`, JSON.stringify(settings));
            };


            const saveMonthlyData = () => {
                const key = `calculatorData_${activeProfile}-${currentDate.getFullYear()}-${currentDate.getMonth()}`;
                localStorage.setItem(key, JSON.stringify(selectedDays));
            };


            const loadMonthlyData = () => {
                const key = `calculatorData_${activeProfile}-${currentDate.getFullYear()}-${currentDate.getMonth()}`;
                const savedData = localStorage.getItem(key);
                if (savedData) {
                    selectedDays = JSON.parse(savedData);
                } else {
                    selectedDays = {};
                }
            };

            const renderCalendar = () => {
                const year = currentDate.getFullYear();
                const month = currentDate.getMonth();
                const firstDayOfMonth = new Date(year, month, 1).getDay();
                const lastDayOfMonth = new Date(year, month + 1, 0).getDate();
                const monthNames = ["Január", "Február", "Március", "Április", "Május", "Június", "Július", "Augusztus", "Szeptember", "Október", "November", "December"];
                currentMonthEl.textContent = `${monthNames[month]} ${year}`;
                calendarDaysEl.innerHTML = '';

                let startDayIndex = firstDayOfMonth === 0 ? 6 : firstDayOfMonth - 1;

                for (let i = 0; i < startDayIndex; i++) {
                    const emptyDiv = document.createElement('div');
                    emptyDiv.classList.add('empty-day', 'p-2');
                    calendarDaysEl.appendChild(emptyDiv);
                }

                for (let i = 1; i <= lastDayOfMonth; i++) {
                    const dayDiv = document.createElement('div');
                    dayDiv.classList.add('day', 'rounded-lg', 'bg-gray-800', 'hover:bg-gray-700', 'transition-colors');
                    const dateString = `${year}-${String(month + 1).padStart(2, '0')}-${String(i).padStart(2, '0')}`;
                    dayDiv.dataset.date = dateString;

                    const dayNumber = document.createElement('span');
                    dayNumber.textContent = i;
                    dayNumber.classList.add('day-number', 'font-bold');
                    dayDiv.appendChild(dayNumber);

                    if (selectedDays[dateString]) {
                        const shiftData = selectedDays[dateString];
                        dayDiv.classList.add('selected');

                        let displayString = '';

                        if (shiftData.isSickLeave) {
                            dayDiv.classList.add('sick-leave');
                            displayString = `${shiftData.sickLeaveHours || 0} óra`;
                        } else if (shiftData.isVacation) {
                            dayDiv.classList.add('vacation');
                            displayString = `${shiftData.vacationHours || 0} óra`;
                        } else {
                            let workHours = 0;
                            if (shiftData.startTime && shiftData.endTime) {
                                if (shiftData.startTime === shiftData.endTime) {
                                    workHours = 0;
                                } else {
                                    const start = new Date(`2000-01-01T${shiftData.startTime}`);
                                    let end = new Date(`2000-01-01T${shiftData.endTime}`);
                                    if (end < start) end.setDate(end.getDate() + 1);
                                    workHours = (end - start) / (1000 * 60 * 60);
                                }
                            }

                            let overtimeHours = 0;
                            if (shiftData.isOvertime && shiftData.overtimeStartTime && shiftData.overtimeEndTime) {
                                const ot_start = new Date(`2000-01-01T${shiftData.overtimeStartTime}`);
                                let ot_end = new Date(`2000-01-01T${shiftData.overtimeEndTime}`);
                                if (ot_end < ot_start) ot_end.setDate(ot_end.getDate() + 1);
                                overtimeHours = (ot_end - ot_start) / (1000 * 60 * 60);
                            }

                            if (workHours > 0 || overtimeHours > 0) {
                                let normalHoursText = workHours > 0 ? `${workHours.toFixed(1).replace('.0', '')} óra` : '';
                                let overtimeText = overtimeHours > 0 ? `(+${overtimeHours.toFixed(1).replace('.0','')}T)` : '';
                                
                                displayString = `${normalHoursText} ${overtimeText}`.trim();

                                if (overtimeHours > 0) {
                                     if (workHours === 0 || isNaN(workHours)) {
                                        dayDiv.classList.add('overtime-full');
                                     } else {
                                        dayDiv.classList.add('overtime');
                                     }
                                }
                            }
                        }

                        if (displayString) {
                            const hoursSpan = document.createElement('span');
                            hoursSpan.textContent = displayString;
                            hoursSpan.classList.add('hours', 'mt-1');
                            dayDiv.appendChild(hoursSpan);
                        }
                    } else {
                         dayDiv.classList.add('hover:bg-gray-700');
                    }

                    dayDiv.addEventListener('click', () => {
                        activeDate = dateString;
                        templateSelectorModal.value = ""; // Reset template selector
                        const shiftData = selectedDays[activeDate] || { startTime: '09:00', endTime: '17:00', overtimeStartTime: '17:00', overtimeEndTime: '18:00', overtimeRate: 50 };
                        
                        // Fill modal from saved data or defaults
                        startTimeInput.value = shiftData.startTime;
                        endTimeInput.value = shiftData.endTime;
                        overtimeCheckbox.checked = shiftData.isOvertime || false;
                        overtimeStartTimeInput.value = shiftData.overtimeStartTime;
                        overtimeEndTimeInput.value = shiftData.overtimeEndTime;
                        overtimeRateInputModal.value = shiftData.overtimeRate || 50;
                        vacationCheckbox.checked = shiftData.isVacation || false;
                        vacationHoursInput.value = shiftData.vacationHours || 8;
                        sickLeaveCheckbox.checked = shiftData.isSickLeave || false;
                        sickLeaveHoursInput.value = shiftData.sickLeaveHours || 8;
                        sickLeavePercentInput.value = shiftData.sickLeavePercent || 70;

                        shiftModal.style.display = 'flex';
                        updateModalInputsState();
                    });
                    calendarDaysEl.appendChild(dayDiv);
                }
            };

            const calculate = () => {
                const hourlyRate = parseFloat(hourlyRateInput.value) || 0;
                const vacationHourlyRate = parseFloat(vacationHourlyRateInput.value) || 0;
                const nightRate = (parseFloat(nightRateInput.value) || 0) / 100;
                const nightStart = parseFloat(nightStartInput.value) || 0;
                const nightEnd = parseFloat(nightEndInput.value) || 0;
                const eveningRate = (parseFloat(eveningRateInput.value) || 0) / 100;
                const eveningStart = parseFloat(eveningStartInput.value) || 0;
                const eveningEnd = parseFloat(eveningEndInput.value) || 0;
                const weekendRate = (parseFloat(weekendRateInput.value) || 0) / 100;
                const weekendOption = weekendOptionSelect.value;
                const isUnder25 = under25Checkbox.checked;
                const isUnder30mother = under30motherCheckbox.checked;
                const isMarried = marriedCheckbox.checked;
                const hasPersonalDeduction = personalDeductionCheckbox.checked;
                const isRetiredEmployee = retiredEmployeeCheckbox.checked;
                const isMother4plus = mother4plusCheckbox.checked;
                const isEKHO = ekhoCheckbox.checked;

                let totalHours = 0, baseBrutto = 0, nightBrutto = 0, eveningBrutto = 0, weekendBrutto = 0, overtimeBrutto = 0, totalVacationHours = 0, vacationBrutto = 0, totalBenefitsValue = 0, savings = 0, sickLeaveBrutto = 0, totalSickLeaveHours = 0, totalNightHours = 0, totalEveningHours = 0, totalWeekendHours = 0, totalOvertimeHours = 0, travelAllowance = 0;

                // Munkanapok számolása
                let workDaysCount = 0;
                for (const date in selectedDays) {
                    const shiftData = selectedDays[date];
                    if (!shiftData.isVacation && !shiftData.isSickLeave) {
                        const hasWorkTime = (shiftData.startTime && shiftData.endTime && shiftData.startTime !== shiftData.endTime);
                        const hasOvertime = (shiftData.isOvertime && shiftData.overtimeStartTime && shiftData.overtimeEndTime && shiftData.overtimeStartTime !== shiftData.overtimeEndTime);
                        if (hasWorkTime || hasOvertime) {
                            workDaysCount++;
                        }
                    }
                }

                // Travel Allowance Calculation
                const travelType = document.querySelector('input[name="travelAllowanceType"]:checked').value;
                if (travelType === 'pass') {
                    travelAllowance = parseFloat(passAmountInput.value) || 0;
                } else if (travelType === 'fuel') {
                    const distance = parseFloat(tripDistanceInput.value) || 0;
                    const kmCost = parseFloat(kmCostInput.value) || 0;
                    if (distance > 0 && kmCost > 0 && workDaysCount > 0) {
                        travelAllowance = (distance * 2) * workDaysCount * kmCost;
                    }
                }


                document.querySelectorAll('.benefit-field').forEach(div => {
                    const valueInput = div.querySelector('input[type="number"]');
                    totalBenefitsValue += parseFloat(valueInput.value) || 0;
                });

                for (const date in selectedDays) {
                    const shiftData = selectedDays[date];

                    if (shiftData.isVacation) {
                        const vacationHours = parseFloat(shiftData.vacationHours) || 0;
                        totalVacationHours += vacationHours;
                        vacationBrutto += vacationHours * vacationHourlyRate;
                        continue;
                    }
                     if (shiftData.isSickLeave) {
                        const sickHours = parseFloat(shiftData.sickLeaveHours) || 0;
                        const sickPercent = (parseFloat(shiftData.sickLeavePercent) || 0) / 100;
                        totalSickLeaveHours += sickHours;
                        sickLeaveBrutto += sickHours * hourlyRate * sickPercent;
                        continue;
                    }

                    const calculateAllowances = (start, end) => {
                        if (!start || !end || end <= start) return;
                        let currentHour = new Date(start);
                        while (currentHour < end) {
                            const h = currentHour.getHours();
                            const nextHour = new Date(currentHour);
                            nextHour.setHours(nextHour.getHours() + 1);
                            const overlapStart = Math.max(currentHour, start);
                            const overlapEnd = Math.min(nextHour, end);
                            const overlapFraction = (overlapEnd - overlapStart) / (1000 * 60 * 60);

                            if (overlapFraction > 0) {
                                if (eveningStart < eveningEnd ? (h >= eveningStart && h < eveningEnd) : (h >= eveningStart || h < eveningEnd)) {
                                    totalEveningHours += overlapFraction;
                                }
                                if (nightStart < nightEnd ? (h >= nightStart && h < nightEnd) : (h >= nightStart || h < nightEnd)) {
                                    totalNightHours += overlapFraction;
                                }
                                const dayOfWeek = currentHour.getDay();
                                const isWeekendDay = (weekendOption === 'all' && (dayOfWeek === 0 || dayOfWeek === 6)) || (weekendOption === 'saturday' && dayOfWeek === 6) || (weekendOption === 'sunday' && dayOfWeek === 0);
                                if (isWeekendDay) {
                                    totalWeekendHours += overlapFraction;
                                }
                            }
                            currentHour.setHours(currentHour.getHours() + 1);
                        }
                    };

                    if (shiftData.startTime && shiftData.endTime && shiftData.startTime !== shiftData.endTime) {
                        const start = new Date(`${date}T${shiftData.startTime}`);
                        let end = new Date(`${date}T${shiftData.endTime}`);
                        if (end < start) end.setDate(end.getDate() + 1);
                        
                        const workHours = (end - start) / (1000 * 60 * 60);
                        if (workHours > 0) {
                            totalHours += workHours;
                            baseBrutto += workHours * hourlyRate;
                            calculateAllowances(start, end);
                        }
                    }

                    if (shiftData.isOvertime && shiftData.overtimeStartTime && shiftData.overtimeEndTime && shiftData.overtimeStartTime !== shiftData.overtimeEndTime) {
                        const ot_start = new Date(`${date}T${shiftData.overtimeStartTime}`);
                        let ot_end = new Date(`${date}T${shiftData.overtimeEndTime}`);
                        if (ot_end < ot_start) ot_end.setDate(ot_end.getDate() + 1);
                        
                        const overtimeHours = (ot_end - ot_start) / (1000 * 60 * 60);
                        if(overtimeHours > 0){
                            const overtimeRate = (parseFloat(shiftData.overtimeRate) || 0) / 100;
                            totalHours += overtimeHours;
                            totalOvertimeHours += overtimeHours;
                            baseBrutto += overtimeHours * hourlyRate;
                            overtimeBrutto += overtimeHours * hourlyRate * overtimeRate;
                            calculateAllowances(ot_start, ot_end);
                        }
                    }
                }
                
                nightBrutto = totalNightHours * hourlyRate * nightRate;
                eveningBrutto = totalEveningHours * hourlyRate * eveningRate;
                weekendBrutto = totalWeekendHours * hourlyRate * weekendRate;

                const totalBrutto = baseBrutto + nightBrutto + eveningBrutto + weekendBrutto + overtimeBrutto + vacationBrutto + sickLeaveBrutto + totalBenefitsValue + travelAllowance;

                let netto = 0;
                savingsListEl.innerHTML = '';
                savingsPlaceholderEl.classList.remove('hidden');

                if (isEKHO) {
                    netto = totalBrutto * (1 - 0.13);
                    savings = 0;
                } else {
                    const personalIncomeTaxRate = 0.15, tbContributionRate = 0.185;
                    let taxBase = totalBrutto - travelAllowance; // Travel allowance is often tax-free up to a limit
                    let contributionBase = totalBrutto - totalBenefitsValue - travelAllowance;
                    if(isRetiredEmployee) contributionBase = 0;

                    let taxBaseReduction = 0;
                    savingsPlaceholderEl.classList.add('hidden');

                    if(isMother4plus){
                         const fullExemption = taxBase;
                         taxBaseReduction += fullExemption;
                         savingsListEl.innerHTML += `<p class="text-gray-300">4+ gyermekes anyák kedv.: ${formatCurrency(fullExemption * personalIncomeTaxRate)}</p>`;
                    } else {
                        if (isUnder25) {
                            const exemption = Math.min(taxBase, 576601);
                            taxBaseReduction += exemption;
                            savingsListEl.innerHTML += `<p class="text-gray-300">25 év alatti kedv.: ${formatCurrency(exemption * personalIncomeTaxRate)}</p>`;
                        }
                        if (isUnder30mother) {
                           const currentTaxBase = taxBase - taxBaseReduction;
                           if(currentTaxBase > 0) {
                                const exemption = Math.min(currentTaxBase, 576601);
                                taxBaseReduction += exemption;
                                savingsListEl.innerHTML += `<p class="text-gray-300">30 alatti anyák kedv.: ${formatCurrency(exemption * personalIncomeTaxRate)}</p>`;
                           }
                        }
                    }

                    if (isMarried) {
                        taxBaseReduction += 33335;
                        savingsListEl.innerHTML += `<p class="text-gray-300">Friss házasok kedv.: ${formatCurrency(5000)}</p>`;
                    }
                    if (hasPersonalDeduction) {
                        taxBaseReduction += 88933;
                        savingsListEl.innerHTML += `<p class="text-gray-300">Személyi kedv.: ${formatCurrency(13340)}</p>`;
                    }
                    
                    if(savingsListEl.innerHTML === '') savingsPlaceholderEl.classList.remove('hidden');
                    
                    const finalTaxBase = Math.max(0, taxBase - taxBaseReduction);
                    const personalIncomeTax = finalTaxBase * personalIncomeTaxRate;
                    const tbContribution = contributionBase * tbContributionRate;

                    netto = totalBrutto - personalIncomeTax - tbContribution;
                    savings = (taxBase - finalTaxBase) * personalIncomeTaxRate + (isMarried ? 5000 : 0) + (hasPersonalDeduction ? 13340 : 0);
                }
                
                animateValue(totalHoursEl, totalHours, " óra", true);
                animateValue(baseBruttoEl, baseBrutto, " Ft");
                animateValue(nightBreakdownEl, nightBrutto, " Ft", false, totalNightHours, " óra");
                animateValue(eveningBreakdownEl, eveningBrutto, " Ft", false, totalEveningHours, " óra");
                animateValue(weekendBreakdownEl, weekendBrutto, " Ft", false, totalWeekendHours, " óra");
                animateValue(overtimeBreakdownEl, overtimeBrutto, " Ft", false, totalOvertimeHours, " óra");
                animateValue(vacationHoursEl, vacationBrutto, " Ft", false, totalVacationHours, " óra");
                animateValue(sickLeaveBreakdownEl, sickLeaveBrutto, " Ft", false, totalSickLeaveHours, " óra");
                
                if (travelAllowance > 0) {
                    travelAllowanceContainer.classList.remove('hidden');
                    animateValue(travelAllowanceBreakdownEl, travelAllowance, " Ft");
                } else {
                    travelAllowanceContainer.classList.add('hidden');
                }

                animateValue(nettoOutputEl, netto, " Ft");
                animateValue(totalSavingsEl, savings, " Ft");

                if (totalBenefitsValue > 0) {
                    totalBenefitsContainer.classList.remove('hidden');
                    animateValue(totalBenefitsEl, totalBenefitsValue, " Ft");
                } else {
                    totalBenefitsContainer.classList.add('hidden');
                }

                updateChart(baseBrutto, nightBrutto, eveningBrutto, weekendBrutto, overtimeBrutto, vacationBrutto, sickLeaveBrutto, totalBenefitsValue, travelAllowance);
            };

            function animateValue(obj, end, suffix, isHours = false, prefixValue = null, prefixSuffix = null) {
                let start = parseFloat(obj.textContent.replace(/[^\d,]/g, "").replace(",", ".")) || 0;
                let duration = 1000;
                let startTime = null;

                function step(timestamp) {
                    if (!startTime) startTime = timestamp;
                    let progress = timestamp - startTime;
                    let value = start + (end - start) * Math.min(progress / duration, 1);
                    let formattedValue = Math.round(value).toLocaleString('hu-HU');
                    
                    if (isHours) {
                         obj.textContent = `${value.toFixed(1).replace('.0','')} ${suffix}`;
                    } else if (prefixValue !== null) {
                        obj.textContent = `${Number(prefixValue).toFixed(1).replace('.0','')} ${prefixSuffix} (${formattedValue} ${suffix})`;
                    } else {
                        obj.textContent = `${formattedValue} ${suffix}`;
                    }

                    if (progress < duration) {
                        requestAnimationFrame(step);
                    } else {
                         if (isHours) {
                            obj.textContent = `${end.toFixed(1).replace('.0','')} ${suffix}`;
                         } else if (prefixValue !== null) {
                            obj.textContent = `${Number(prefixValue).toFixed(1).replace('.0','')} ${prefixSuffix} (${Math.round(end).toLocaleString('hu-HU')} ${suffix})`;
                         } else {
                            obj.textContent = `${Math.round(end).toLocaleString('hu-HU')} ${suffix}`;
                         }
                    }
                }

                requestAnimationFrame(step);
            }

            const allSettingsControls = [...settingsInputs, ...settingsCheckboxes];
            allSettingsControls.forEach(el => {
                el.addEventListener('change', () => {
                    saveSettings();
                    calculate();
                });
            });

            travelAllowanceRadios.forEach(radio => {
                radio.addEventListener('change', () => {
                    handleTravelAllowanceChange();
                    saveSettings();
                    calculate();
                });
            });

            function handleTravelAllowanceChange() {
                const selectedType = document.querySelector('input[name="travelAllowanceType"]:checked').value;
                passInputsContainer.classList.toggle('hidden', selectedType !== 'pass');
                fuelInputsContainer.classList.toggle('hidden', selectedType !== 'fuel');
            }

            benefitsContainer.addEventListener('change', (e) => {
                if (e.target.closest('.benefit-field')) {
                    saveSettings();
                    calculate();
                }
            });

            calculateBtn.addEventListener('click', calculate);

            const updateChart = (base, night, evening, weekend, overtime, vacation, sickLeave, benefitsValue, travel) => {
                d3.select("#chart-container svg").remove();
                const data = [ 
                    { label: "Alap Bruttó", value: base }, 
                    { label: "Éjszakai pótlék", value: night }, 
                    { label: "Délutáni pótlék", value: evening }, 
                    { label: "Hétvégi pótlék", value: weekend }, 
                    { label: "Túlóra pótlék", value: overtime }, 
                    { label: "Szabadság", value: vacation }, 
                    { label: "Táppénz", value: sickLeave },
                    { label: "Bejárás", value: travel },
                    { label: "Juttatások", value: benefitsValue }, 
                ].filter(d => d.value > 0.1);
                if(data.length === 0) return;

                const margin = { top: 20, right: 30, bottom: 40, left: 100 };
                const fullWidth = Math.min(500, document.getElementById('chart-panel').clientWidth);
                const fullHeight = data.length * 40 + margin.top + margin.bottom;
                const width = fullWidth - margin.left - margin.right;
                const height = fullHeight - margin.top - margin.bottom;

                const svg = d3.select("#chart-container").append("svg").attr("width", fullWidth).attr("height", fullHeight).append("g").attr("transform", `translate(${margin.left},${margin.top})`);
                const x = d3.scaleLinear().domain([0, d3.max(data, d => d.value)]).range([0, width]);
                const y = d3.scaleBand().domain(data.map(d => d.label)).range([0, height]).padding(0.2);
                const color = d3.scaleOrdinal(d3.schemePaired);
                svg.append("g").attr("transform", `translate(0,${height})`).call(d3.axisBottom(x).ticks(5).tickFormat(d => `${d / 1000}k`)).attr("class", "axis");
                const yAxis = svg.append("g").call(d3.axisLeft(y)).attr("class", "axis");
                yAxis.selectAll("text").style("font-size", "12px");
                const bars = svg.selectAll(".bar").data(data).join("rect").attr("class", "bar").attr("x", x(0)).attr("y", d => y(d.label)).attr("height", y.bandwidth()).attr("fill", (d,i) => color(i)).attr("width", 0);
                bars.transition().duration(1000).attr("width", d => x(d.value));
                const tooltip = d3.select("#tooltip");
                svg.selectAll(".bar").on("mouseover", (event, d) => { tooltip.style("opacity", 1).html(`<strong>${d.label}</strong><br>${formatCurrency(d.value)}`); }).on("mousemove", (event) => { tooltip.style("left", `${event.pageX + 10}px`).style("top", `${event.pageY - 20}px`); }).on("mouseout", () => { tooltip.style("opacity", 0); });
            };

            saveAndContinueBtn.addEventListener('click', () => {
                const resultsContainer = document.querySelector('.results-container');
                html2canvas(resultsContainer, { backgroundColor: '#0d1117' }).then(canvas => {
                    const imgData = canvas.toDataURL('image/png');
                    const { jsPDF } = window.jspdf;
                    const pdf = new jsPDF('p', 'mm', 'a4');
                    const imgProps = pdf.getImageProperties(imgData);
                    const pdfWidth = pdf.internal.pageSize.getWidth();
                    const pdfHeight = (imgProps.height * pdfWidth) / imgProps.width;
                    pdf.addImage(imgData, 'PNG', 0, 0, pdfWidth, pdfHeight);
                    pdf.save(`fizetes-osszefoglalo-${currentDate.getFullYear()}-${currentDate.getMonth() + 1}.pdf`);
                    pdfConfirmModal.style.display = 'none';
                    currentDate.setMonth(currentDate.getMonth() + monthChangeDirection);
                    loadMonthlyData(); renderCalendar(); calculate();
                });
            });

            continueWithoutSavingBtn.addEventListener('click', () => {
                pdfConfirmModal.style.display = 'none';
                currentDate.setMonth(currentDate.getMonth() + monthChangeDirection);
                loadMonthlyData(); renderCalendar(); calculate();
            });

            prevBtn.addEventListener('click', () => { monthChangeDirection = -1; pdfConfirmModal.style.display = 'flex'; });
            nextBtn.addEventListener('click', () => { monthChangeDirection = 1; pdfConfirmModal.style.display = 'flex'; });
            
            function updateModalInputsState() {
                const isOvertime = overtimeCheckbox.checked, isVacation = vacationCheckbox.checked, isSickLeave = sickLeaveCheckbox.checked;
                overtimeInputsContainer.classList.toggle('hidden', !isOvertime);
                const isTimeInputDisabled = isVacation || isSickLeave;
                startTimeInput.disabled = isTimeInputDisabled; endTimeInput.disabled = isTimeInputDisabled;
                startTimeInput.classList.toggle('disabled-input', isTimeInputDisabled); endTimeInput.classList.toggle('disabled-input', isTimeInputDisabled);
                overtimeCheckbox.disabled = isTimeInputDisabled;
                vacationCheckbox.disabled = isSickLeave || isOvertime;
                sickLeaveCheckbox.disabled = isVacation || isOvertime;
                vacationHoursInput.classList.toggle('disabled-input', !isVacation);
                sickLeaveHoursInput.classList.toggle('disabled-input', !isSickLeave);
                sickLeavePercentInput.classList.toggle('disabled-input', !isSickLeave);
            }

            overtimeCheckbox.addEventListener('change', () => { if (overtimeCheckbox.checked) { vacationCheckbox.checked = false; sickLeaveCheckbox.checked = false; } updateModalInputsState(); });
            vacationCheckbox.addEventListener('change', () => { if (vacationCheckbox.checked) { overtimeCheckbox.checked = false; sickLeaveCheckbox.checked = false; } updateModalInputsState(); });
            sickLeaveCheckbox.addEventListener('change', () => { if (sickLeaveCheckbox.checked) { overtimeCheckbox.checked = false; vacationCheckbox.checked = false; } updateModalInputsState(); });

            saveShiftBtn.addEventListener('click', () => {
                const shiftData = {
                    startTime: startTimeInput.value,
                    endTime: endTimeInput.value,
                    isOvertime: overtimeCheckbox.checked,
                    overtimeStartTime: overtimeStartTimeInput.value,
                    overtimeEndTime: overtimeEndTimeInput.value,
                    overtimeRate: parseFloat(overtimeRateInputModal.value) || 0,
                    isVacation: vacationCheckbox.checked,
                    isSickLeave: sickLeaveCheckbox.checked,
                    vacationHours: parseFloat(vacationHoursInput.value) || 0,
                    sickLeaveHours: parseFloat(sickLeaveHoursInput.value) || 0,
                    sickLeavePercent: parseFloat(sickLeavePercentInput.value) || 0
                };
                
                let hasData = shiftData.isVacation || shiftData.isSickLeave || (shiftData.startTime && shiftData.endTime && shiftData.startTime !== shiftData.endTime) || (shiftData.isOvertime && shiftData.overtimeStartTime && shiftData.overtimeEndTime && shiftData.overtimeStartTime !== shiftData.overtimeEndTime);

                if (hasData) {
                    selectedDays[activeDate] = shiftData;
                } else {
                    delete selectedDays[activeDate];
                }
                shiftModal.style.display = 'none';
                saveMonthlyData(); renderCalendar(); calculate();
            });

            cancelShiftBtn.addEventListener('click', () => {
                if (activeDate) delete selectedDays[activeDate];
                shiftModal.style.display = 'none';
                saveMonthlyData(); renderCalendar(); calculate();
            });
            
            // --- PROFILE FUNCTIONS ---
            const loadProfiles = () => {
                const savedProfiles = JSON.parse(localStorage.getItem('calculatorProfiles'));
                if (savedProfiles && savedProfiles.length > 0) profiles = savedProfiles;
                const lastProfile = localStorage.getItem('calculatorLastProfile');
                activeProfile = (lastProfile && profiles.includes(lastProfile)) ? lastProfile : profiles[0];
            };
            const saveProfiles = () => {
                localStorage.setItem('calculatorProfiles', JSON.stringify(profiles));
                localStorage.setItem('calculatorLastProfile', activeProfile);
            };
            const updateProfileSelector = () => {
                profileSelector.innerHTML = '';
                profiles.forEach(profileName => { const option = document.createElement('option'); option.value = profileName; option.textContent = profileName; profileSelector.appendChild(option); });
                profileSelector.value = activeProfile;
            };
            const switchProfile = (newProfileName) => {
                if (profiles.includes(newProfileName)) {
                    activeProfile = newProfileName;
                    saveProfiles();
                    updateProfileSelector();
                    loadSettings();
                    loadTemplates();
                    updateTemplateSelectors();
                    loadMonthlyData();
                    renderCalendar();
                    calculate();
                }
            };
            
            const toggleProfileEditView = (showEdit) => {
                if(showEdit) {
                    editProfileNameInput.value = activeProfile;
                    profileDisplayView.classList.add('hidden');
                    profileEditView.classList.remove('hidden');
                    editProfileNameInput.focus();
                } else {
                    profileDisplayView.classList.remove('hidden');
                    profileEditView.classList.add('hidden');
                }
            };

            editProfileBtn.addEventListener('click', () => toggleProfileEditView(true));
            cancelEditProfileBtn.addEventListener('click', () => toggleProfileEditView(false));
            
            saveProfileNameBtn.addEventListener('click', () => {
                const oldName = activeProfile;
                const newName = editProfileNameInput.value.trim();
                
                if(!newName) { showMessageBox("A profilnév nem lehet üres."); return; }
                if(newName !== oldName && profiles.includes(newName)) { showMessageBox("Már létezik profil ezzel a névvel."); return; }
                
                const profileIndex = profiles.indexOf(oldName);
                if (profileIndex > -1) profiles[profileIndex] = newName;
                
                const settings = localStorage.getItem(`calculatorSettings_${oldName}`);
                if (settings) { localStorage.setItem(`calculatorSettings_${newName}`, settings); localStorage.removeItem(`calculatorSettings_${oldName}`); }

                const templates = localStorage.getItem(`calculatorTemplates_${oldName}`);
                if(templates) { localStorage.setItem(`calculatorTemplates_${newName}`, templates); localStorage.removeItem(`calculatorTemplates_${oldName}`); }

                Object.keys(localStorage).forEach(key => {
                    if (key.startsWith(`calculatorData_${oldName}-`)) {
                        const newKey = key.replace(`calculatorData_${oldName}-`, `calculatorData_${newName}-`);
                        localStorage.setItem(newKey, localStorage.getItem(key));
                        localStorage.removeItem(key);
                    }
                });

                activeProfile = newName;
                saveProfiles();
                updateProfileSelector();
                toggleProfileEditView(false);
            });

            addProfileBtn.addEventListener('click', () => {
                const newName = newProfileNameInput.value.trim();
                if (newName && !profiles.includes(newName)) {
                    profiles.push(newName);
                    newProfileNameInput.value = '';
                    switchProfile(newName);
                } else if (!newName) { showMessageBox("A profil neve nem lehet üres.");
                } else { showMessageBox("Már létezik profil ezzel a névvel."); }
            });
            deleteProfileBtn.addEventListener('click', () => {
                if (profiles.length <= 1) { showMessageBox("Az utolsó profilt nem lehet törölni."); return; }
                if (confirm(`Biztosan törölni szeretnéd a(z) "${activeProfile}" profilt és minden adatát? Ez a művelet nem vonható vissza.`)) {
                    const profileToDelete = activeProfile;
                    profiles = profiles.filter(p => p !== profileToDelete);
                    Object.keys(localStorage).filter(key => key.startsWith(`calculatorData_${profileToDelete}-`)).forEach(key => localStorage.removeItem(key));
                    localStorage.removeItem(`calculatorSettings_${profileToDelete}`);
                    localStorage.removeItem(`calculatorTemplates_${profileToDelete}`);
                    switchProfile(profiles[0]);
                    saveProfiles();
                }
            });
            profileSelector.addEventListener('change', () => { switchProfile(profileSelector.value); });

            // --- TEMPLATE FUNCTIONS ---
            const loadTemplates = () => {
                const savedTemplates = localStorage.getItem(`calculatorTemplates_${activeProfile}`);
                shiftTemplates = savedTemplates ? JSON.parse(savedTemplates) : {};
            };
            const saveTemplates = () => {
                localStorage.setItem(`calculatorTemplates_${activeProfile}`, JSON.stringify(shiftTemplates));
            };
            const updateTemplateSelectors = () => {
                const selectors = [templateSelector, templateSelectorModal];
                selectors.forEach(selector => {
                    const currentValue = selector.value;
                    selector.innerHTML = selector === templateSelectorModal ? '<option value="">-- Egyéni beállítás --</option>' : '';
                    if (Object.keys(shiftTemplates).length === 0 && selector.id === 'templateSelector') {
                         selector.innerHTML = '<option value="">Nincsenek sablonok</option>';
                    } else {
                        for (const name in shiftTemplates) {
                            const option = document.createElement('option');
                            option.value = name;
                            option.textContent = name;
                            selector.appendChild(option);
                        }
                    }
                    selector.value = currentValue;
                });
            };

            function updateTemplateModalInputsState() {
                const isOvertime = templateOvertimeCheckbox.checked, isVacation = templateVacationCheckbox.checked, isSickLeave = templateSickLeaveCheckbox.checked;
                templateOvertimeInputs.classList.toggle('hidden', !isOvertime);
                const isTimeInputDisabled = isVacation || isSickLeave;
                templateStartTime.disabled = isTimeInputDisabled; templateEndTime.disabled = isTimeInputDisabled;
                templateStartTime.classList.toggle('disabled-input', isTimeInputDisabled); templateEndTime.classList.toggle('disabled-input', isTimeInputDisabled);
                templateOvertimeCheckbox.disabled = isTimeInputDisabled;
                templateVacationCheckbox.disabled = isSickLeave || isOvertime;
                templateSickLeaveCheckbox.disabled = isVacation || isOvertime;
            }

            templateOvertimeCheckbox.addEventListener('change', () => { if (templateOvertimeCheckbox.checked) { templateVacationCheckbox.checked = false; templateSickLeaveCheckbox.checked = false; } updateTemplateModalInputsState(); });
            templateVacationCheckbox.addEventListener('change', () => { if (templateVacationCheckbox.checked) { templateOvertimeCheckbox.checked = false; templateSickLeaveCheckbox.checked = false; } updateTemplateModalInputsState(); });
            templateSickLeaveCheckbox.addEventListener('change', () => { if (templateSickLeaveCheckbox.checked) { templateOvertimeCheckbox.checked = false; templateVacationCheckbox.checked = false; } updateTemplateModalInputsState(); });
            
            addTemplateBtn.addEventListener('click', () => {
                editingTemplateName = null;
                templateModalTitle.textContent = "Új sablon létrehozása";
                templateNameInput.value = "";
                templateStartTime.value = "09:00";
                templateEndTime.value = "17:00";
                templateOvertimeCheckbox.checked = false;
                templateVacationCheckbox.checked = false;
                templateSickLeaveCheckbox.checked = false;
                updateTemplateModalInputsState();
                templateModal.style.display = 'flex';
            });
            
            editTemplateBtn.addEventListener('click', () => {
                const name = templateSelector.value;
                if (!name || !shiftTemplates[name]) {
                    showMessageBox("Nincs kiválasztva szerkeszthető sablon.");
                    return;
                }
                editingTemplateName = name;
                const data = shiftTemplates[name];

                templateModalTitle.textContent = "Sablon szerkesztése";
                templateNameInput.value = name;
                templateStartTime.value = data.startTime;
                templateEndTime.value = data.endTime;
                templateOvertimeCheckbox.checked = data.isOvertime;
                templateOvertimeStartTime.value = data.overtimeStartTime;
                templateOvertimeEndTime.value = data.overtimeEndTime;
                templateOvertimeRate.value = data.overtimeRate;
                templateVacationCheckbox.checked = data.isVacation;
                templateVacationHours.value = data.vacationHours;
                templateSickLeaveCheckbox.checked = data.isSickLeave;
                templateSickLeaveHours.value = data.sickLeaveHours;
                templateSickLeavePercent.value = data.sickLeavePercent;
                updateTemplateModalInputsState();
                templateModal.style.display = 'flex';
            });

            deleteTemplateBtn.addEventListener('click', () => {
                const name = templateSelector.value;
                if (!name || !shiftTemplates[name]) {
                    showMessageBox("Nincs kiválasztva törölhető sablon.");
                    return;
                }
                if (confirm(`Biztosan törli a(z) "${name}" sablont?`)) {
                    delete shiftTemplates[name];
                    saveTemplates();
                    updateTemplateSelectors();
                }
            });

            saveTemplateBtn.addEventListener('click', () => {
                const newName = templateNameInput.value.trim();
                if (!newName) {
                    showMessageBox("A sablon neve nem lehet üres.");
                    return;
                }
                if (newName !== editingTemplateName && shiftTemplates[newName]) {
                    showMessageBox("Már létezik sablon ezzel a névvel.");
                    return;
                }

                const templateData = {
                    startTime: templateStartTime.value,
                    endTime: templateEndTime.value,
                    isOvertime: templateOvertimeCheckbox.checked,
                    overtimeStartTime: templateOvertimeStartTime.value,
                    overtimeEndTime: templateOvertimeEndTime.value,
                    overtimeRate: parseFloat(templateOvertimeRate.value) || 0,
                    isVacation: templateVacationCheckbox.checked,
                    vacationHours: parseFloat(templateVacationHours.value) || 0,
                    isSickLeave: templateSickLeaveCheckbox.checked,
                    sickLeaveHours: parseFloat(templateSickLeaveHours.value) || 0,
                    sickLeavePercent: parseFloat(templateSickLeavePercent.value) || 0
                };
                
                if (editingTemplateName && editingTemplateName !== newName) {
                    delete shiftTemplates[editingTemplateName];
                }
                shiftTemplates[newName] = templateData;
                saveTemplates();
                updateTemplateSelectors();
                templateModal.style.display = 'none';
            });

            templateSelectorModal.addEventListener('change', (e) => {
                const templateName = e.target.value;
                const templateData = shiftTemplates[templateName];
                if (templateData) {
                    startTimeInput.value = templateData.startTime;
                    endTimeInput.value = templateData.endTime;
                    overtimeCheckbox.checked = templateData.isOvertime;
                    overtimeStartTimeInput.value = templateData.overtimeStartTime;
                    overtimeEndTimeInput.value = templateData.overtimeEndTime;
                    overtimeRateInputModal.value = templateData.overtimeRate;
                    vacationCheckbox.checked = templateData.isVacation;
                    vacationHoursInput.value = templateData.vacationHours;
                    sickLeaveCheckbox.checked = templateData.isSickLeave;
                    sickLeaveHoursInput.value = templateData.sickLeaveHours;
                    sickLeavePercentInput.value = templateData.sickLeavePercent;
                    updateModalInputsState();
                }
            });
            
            function initializeApp() {
                loadProfiles();
                updateProfileSelector();
                loadSettings();
                loadTemplates();
                updateTemplateSelectors();
                loadMonthlyData();
                renderCalendar();
                calculate();
            }
            
            initializeApp();
        });
    </script>
</body>
</html>

